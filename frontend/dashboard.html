<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockIQ - Gestión Inteligente de Inventario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <style>
        .loading{animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
        .sidebar-item.active{background:rgba(59,130,246,.15);color:#3b82f6;border-right:3px solid #3b82f6}
        .sidebar-item:hover{background:rgba(255,255,255,.05)}
        .page{display:none}.page.active{display:block}
        .badge-critico{background:#fef2f2;color:#dc2626;border:1px solid #fecaca}
        .badge-alto{background:#fff7ed;color:#ea580c;border:1px solid #fed7aa}
        .badge-medio{background:#fefce8;color:#ca8a04;border:1px solid #fef08a}
        .badge-bajo{background:#eff6ff;color:#2563eb;border:1px solid #bfdbfe}
        .badge-stock_agotado{background:#fff1f2;color:#e11d48;border:1px solid #fecdd3}
        .badge-urgente{background:#fef2f2;color:#dc2626;border:1px solid #fecaca}
        .badge-alta{background:#fff7ed;color:#ea580c;border:1px solid #fed7aa}
        .badge-media{background:#fefce8;color:#ca8a04;border:1px solid #fef08a}
        .badge-baja{background:#f0fdf4;color:#16a34a;border:1px solid #bbf7d0}
        select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%236b7280' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;padding-right:28px;-webkit-appearance:none;appearance:none}
        .modal-overlay{background:rgba(0,0,0,.5);backdrop-filter:blur(4px)}
        body{overflow:hidden}
        #main-content{overflow-y:auto}
    </style>
</head>
<body class="bg-gray-50 h-screen flex">

<!-- ============ LOGIN ============ -->
<div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-slate-900 via-blue-900 to-slate-800">
    <div class="w-full max-w-md px-8">
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-blue-600/30">
                <i data-lucide="bar-chart-3" class="w-8 h-8 text-white"></i>
            </div>
            <h1 class="text-3xl font-bold text-white">StockIQ</h1>
            <p class="text-blue-300 mt-1">Gestión Inteligente de Inventario</p>
        </div>
        <div class="bg-white/10 backdrop-blur rounded-2xl p-8 border border-white/20">
            <div id="login-error" class="hidden mb-4 p-3 bg-red-500/20 border border-red-500/30 rounded-lg text-red-200 text-sm"></div>
            <div class="mb-4">
                <label class="block text-blue-200 text-sm mb-2">Usuario</label>
                <input id="login-user" type="text" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-300/50 focus:outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-400" placeholder="usuario">
            </div>
            <div class="mb-6">
                <label class="block text-blue-200 text-sm mb-2">Contraseña</label>
                <input id="login-pass" type="password" class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-blue-300/50 focus:outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-400" placeholder="••••••••">
            </div>
            <button onclick="doLogin()" id="login-btn" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                Ingresar
            </button>
        </div>
    </div>
</div>

<!-- ============ APP SHELL ============ -->
<div id="app" class="hidden w-full h-screen flex">
    <!-- Sidebar -->
    <aside class="w-60 bg-slate-900 flex flex-col flex-shrink-0 h-screen">
        <div class="px-5 py-5 flex items-center gap-3 border-b border-slate-700/50">
            <div class="w-9 h-9 bg-blue-600 rounded-lg flex items-center justify-center">
                <i data-lucide="bar-chart-3" class="w-5 h-5 text-white"></i>
            </div>
            <div>
                <h1 class="text-white font-bold text-lg leading-none">StockIQ</h1>
                <p class="text-slate-400 text-[10px]">Inventario Inteligente</p>
            </div>
        </div>
        <nav class="flex-1 py-4 px-3 space-y-1 overflow-y-auto">
            <a onclick="showPage('dashboard')" class="sidebar-item active flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm cursor-pointer text-slate-300" data-page="dashboard">
                <i data-lucide="layout-dashboard" class="w-4 h-4"></i>Dashboard
            </a>
            <a onclick="showPage('alertas')" class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm cursor-pointer text-slate-300" data-page="alertas">
                <i data-lucide="alert-triangle" class="w-4 h-4"></i>Alertas
                <span id="nav-count-alertas" class="ml-auto px-1.5 py-0.5 rounded text-[10px] bg-red-500/20 text-red-400"></span>
            </a>
            <a onclick="showPage('traslados')" class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm cursor-pointer text-slate-300" data-page="traslados">
                <i data-lucide="truck" class="w-4 h-4"></i>Traslados
                <span id="nav-count-traslados" class="ml-auto px-1.5 py-0.5 rounded text-[10px] bg-purple-500/20 text-purple-400"></span>
            </a>
            <a onclick="showPage('compras')" class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm cursor-pointer text-slate-300" data-page="compras">
                <i data-lucide="shopping-cart" class="w-4 h-4"></i>Compras
            </a>
            <a onclick="showPage('almacenes')" class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm cursor-pointer text-slate-300" data-page="almacenes">
                <i data-lucide="warehouse" class="w-4 h-4"></i>Almacenes
            </a>
            <a onclick="showPage('analisis')" class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm cursor-pointer text-slate-300" data-page="analisis">
                <i data-lucide="pie-chart" class="w-4 h-4"></i>Análisis
            </a>
            <a onclick="showPage('productos')" class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm cursor-pointer text-slate-300" data-page="productos">
                <i data-lucide="search" class="w-4 h-4"></i>Productos
            </a>
            <a onclick="showPage('regionales')" class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm cursor-pointer text-slate-300" data-page="regionales">
                <i data-lucide="map-pin" class="w-4 h-4"></i>Regionales
            </a>
            <div id="nav-admin-section" class="hidden mt-4 pt-4 border-t border-slate-700/50">
                <p class="px-3 mb-2 text-[10px] font-semibold text-slate-500 uppercase tracking-wider">Administración</p>
                <a onclick="showPage('usuarios')" class="sidebar-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm cursor-pointer text-slate-300" data-page="usuarios">
                    <i data-lucide="users" class="w-4 h-4"></i>Usuarios
                </a>
            </div>
        </nav>
        <div class="px-3 py-4 border-t border-slate-700/50">
            <div class="flex items-center gap-3 px-3">
                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white text-xs font-bold" id="user-avatar">A</div>
                <div class="flex-1 min-w-0">
                    <p id="user-name" class="text-sm text-white truncate">Admin</p>
                    <p id="user-role" class="text-[10px] text-slate-400">admin</p>
                </div>
                <button onclick="doLogout()" class="text-slate-400 hover:text-red-400 transition-colors" title="Cerrar sesión">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col h-screen overflow-hidden">
        <!-- Top Bar -->
        <header class="bg-white border-b border-gray-200 px-6 py-3 flex items-center justify-between flex-shrink-0">
            <div class="flex items-center gap-4">
                <h2 id="page-title" class="text-lg font-semibold text-gray-800">Dashboard</h2>
                <div class="relative" id="regional-search-wrap">
                    <button onclick="toggleMultiDrop('regional')" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5 text-gray-600 focus:outline-none focus:border-blue-400 flex items-center gap-1.5 min-w-[140px]">
                        <span id="regional-label">Todas las regionales</span>
                        <i data-lucide="chevron-down" class="w-3.5 h-3.5 ml-auto text-gray-400"></i>
                    </button>
                    <div id="regional-dropdown" class="hidden absolute top-full left-0 mt-1 w-72 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                        <div class="px-3 py-2 border-b border-gray-100">
                            <input id="regional-search" type="text" placeholder="Buscar..." class="w-full text-xs border border-gray-200 rounded px-2 py-1 focus:outline-none focus:border-blue-400" oninput="filterMultiDrop('regional')">
                        </div>
                        <div class="px-3 py-1.5 border-b border-gray-100 flex items-center gap-2">
                            <button onclick="multiSelectAll('regional')" class="text-[10px] text-blue-600 hover:underline">Todos</button>
                            <button onclick="multiClearAll('regional')" class="text-[10px] text-red-500 hover:underline">Ninguno</button>
                        </div>
                        <div id="regional-list" class="max-h-48 overflow-y-auto py-1"></div>
                    </div>
                </div>
                <div class="relative" id="almacen-search-wrap">
                    <button onclick="toggleMultiDrop('almacen')" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5 text-gray-600 focus:outline-none focus:border-blue-400 flex items-center gap-1.5 min-w-[160px]">
                        <span id="almacen-label">Todos los almacenes</span>
                        <i data-lucide="chevron-down" class="w-3.5 h-3.5 ml-auto text-gray-400"></i>
                    </button>
                    <div id="almacen-dropdown" class="hidden absolute top-full left-0 mt-1 w-80 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                        <div class="px-3 py-2 border-b border-gray-100">
                            <input id="almacen-search" type="text" placeholder="Buscar almacén..." class="w-full text-xs border border-gray-200 rounded px-2 py-1 focus:outline-none focus:border-blue-400" oninput="filterMultiDrop('almacen')">
                        </div>
                        <div class="px-3 py-1.5 border-b border-gray-100 flex items-center gap-2">
                            <button onclick="multiSelectAll('almacen')" class="text-[10px] text-blue-600 hover:underline">Todos</button>
                            <button onclick="multiClearAll('almacen')" class="text-[10px] text-red-500 hover:underline">Ninguno</button>
                        </div>
                        <div id="almacen-list" class="max-h-48 overflow-y-auto py-1"></div>
                    </div>
                </div>
                <div class="relative" id="marca-search-wrap">
                    <button onclick="toggleMultiDrop('marca')" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5 text-gray-600 focus:outline-none focus:border-blue-400 flex items-center gap-1.5 min-w-[140px]">
                        <span id="marca-label">Todas las marcas</span>
                        <i data-lucide="chevron-down" class="w-3.5 h-3.5 ml-auto text-gray-400"></i>
                    </button>
                    <div id="marca-dropdown" class="hidden absolute top-full left-0 mt-1 w-72 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                        <div class="px-3 py-2 border-b border-gray-100">
                            <input id="marca-search" type="text" placeholder="Buscar marca..." class="w-full text-xs border border-gray-200 rounded px-2 py-1 focus:outline-none focus:border-blue-400" oninput="filterMultiDrop('marca')">
                        </div>
                        <div class="px-3 py-1.5 border-b border-gray-100 flex items-center gap-2">
                            <button onclick="multiSelectAll('marca')" class="text-[10px] text-blue-600 hover:underline">Todos</button>
                            <button onclick="multiClearAll('marca')" class="text-[10px] text-red-500 hover:underline">Ninguno</button>
                        </div>
                        <div id="marca-list" class="max-h-48 overflow-y-auto py-1"></div>
                    </div>
                </div>
                <div class="relative" id="tiporef-search-wrap">
                    <button onclick="toggleMultiDrop('tiporef')" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5 text-gray-600 focus:outline-none focus:border-blue-400 flex items-center gap-1.5 min-w-[150px]">
                        <span id="tiporef-label">Tipo Referencia</span>
                        <i data-lucide="chevron-down" class="w-3.5 h-3.5 ml-auto text-gray-400"></i>
                    </button>
                    <div id="tiporef-dropdown" class="hidden absolute top-full left-0 mt-1 w-72 bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                        <div class="px-3 py-2 border-b border-gray-100">
                            <input id="tiporef-search" type="text" placeholder="Buscar tipo..." class="w-full text-xs border border-gray-200 rounded px-2 py-1 focus:outline-none focus:border-blue-400" oninput="filterMultiDrop('tiporef')">
                        </div>
                        <div class="px-3 py-1.5 border-b border-gray-100 flex items-center gap-2">
                            <button onclick="multiSelectAll('tiporef')" class="text-[10px] text-blue-600 hover:underline">Todos</button>
                            <button onclick="multiClearAll('tiporef')" class="text-[10px] text-red-500 hover:underline">Ninguno</button>
                        </div>
                        <div id="tiporef-list" class="max-h-48 overflow-y-auto py-1"></div>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span id="last-update" class="text-xs text-gray-400"></span>
                <button onclick="refreshCurrentPage()" class="p-2 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Actualizar">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                </button>
            </div>
        </header>

        <!-- Page Content -->
        <div id="main-content" class="flex-1 overflow-y-auto p-6">

            <!-- ===== DASHBOARD ===== -->
            <div id="page-dashboard" class="page active">
                <div id="kpi-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-7 gap-4 mb-6"></div>
                <div id="salud-cards" class="grid grid-cols-2 md:grid-cols-4 xl:grid-cols-7 gap-3 mb-6"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm font-semibold text-gray-700">Venta sobre Inventario (30 días)</h3>
                            <span id="eficiencia-total" class="text-xs font-bold px-2 py-1 rounded bg-blue-50 text-blue-700"></span>
                        </div>
                        <div style="height:260px;position:relative"><canvas id="chart-ventas"></canvas></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                        <h3 class="text-sm font-semibold text-gray-700 mb-4">Top Productos Vendidos</h3>
                        <div id="top-productos-list" class="max-h-[280px] overflow-y-auto"></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">Inventario por Marca</h3>
                        <div style="height:260px;position:relative"><canvas id="dash-pie-marca"></canvas></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">Inventario por Regional</h3>
                        <div style="height:260px;position:relative"><canvas id="dash-pie-regional"></canvas></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                        <h3 class="text-sm font-semibold text-gray-700 mb-3">Inventario por Estado</h3>
                        <div style="height:260px;position:relative"><canvas id="dash-pie-estado"></canvas></div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">Inventario por Almacén</h3>
                    <div id="dash-tabla-almacenes"></div>
                </div>
            </div>

            <!-- ===== ALERTAS ===== -->
            <div id="page-alertas" class="page">
                <div class="flex flex-wrap items-center gap-3 mb-4">
                    <select id="filtro-alerta-tipo" onchange="loadAlertas()" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5">
                        <option value="">Todos los tipos</option>
                        <option value="STOCK_AGOTADO">Stock Agotado</option>
                        <option value="STOCK_CRITICO">Stock Crítico</option>
                        <option value="STOCK_BAJO">Stock Bajo</option>
                        <option value="SOBREINVENTARIO">Sobreinventario</option>
                        <option value="BAJA_ROTACION">Baja Rotación</option>
                        <option value="SIN_ROTACION">Sin Rotación</option>
                    </select>
                    <select id="filtro-alerta-estado" onchange="loadAlertas()" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5">
                        <option value="PENDIENTE">Pendientes</option>
                        <option value="ATENDIDA">Atendidas</option>
                        <option value="IGNORADA">Ignoradas</option>
                        <option value="">Todas</option>
                    </select>
                    <select id="filtro-alerta-orden" onchange="sortAndRenderAlertas()" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5 bg-blue-50 text-blue-700">
                        <option value="fecha">Más recientes</option>
                        <option value="stock_desc">Mayor stock</option>
                        <option value="stock_asc">Menor stock</option>
                        <option value="valor_desc">Mayor valor</option>
                        <option value="valor_asc">Menor valor</option>
                    </select>
                    <div class="ml-auto">
                        <button onclick="exportData('alertas')" class="flex items-center gap-2 px-3 py-1.5 text-sm bg-green-50 text-green-700 border border-green-200 rounded-lg hover:bg-green-100">
                            <i data-lucide="download" class="w-3.5 h-3.5"></i>Exportar CSV
                        </button>
                    </div>
                </div>
                <div id="alertas-content" class="space-y-2"></div>
            </div>

            <!-- ===== TRASLADOS ===== -->
            <div id="page-traslados" class="page">
                <div class="flex flex-wrap items-center gap-3 mb-4">
                    <select id="filtro-traslado-prioridad" onchange="loadTraslados()" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5">
                        <option value="">Todas las prioridades</option>
                        <option value="URGENTE">Urgente</option>
                        <option value="ALTA">Alta</option>
                        <option value="MEDIA">Media</option>
                        <option value="BAJA">Baja</option>
                    </select>
                    <select id="filtro-traslado-estado" onchange="loadTraslados()" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5">
                        <option value="PENDIENTE">Pendientes</option>
                        <option value="APROBADO">Aprobados</option>
                        <option value="EJECUTADO">Ejecutados</option>
                        <option value="">Todos</option>
                    </select>
                    <select id="filtro-traslado-origen" onchange="sortAndRenderTraslados()" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5">
                        <option value="">Almacén Origen</option>
                    </select>
                    <select id="filtro-traslado-destino" onchange="sortAndRenderTraslados()" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5">
                        <option value="">Almacén Destino</option>
                    </select>
                    <select id="filtro-traslado-orden" onchange="sortAndRenderTraslados()" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5 bg-blue-50 text-blue-700">
                        <option value="prioridad">Por prioridad</option>
                        <option value="stock_desc">Mayor stock sugerido</option>
                        <option value="stock_asc">Menor stock sugerido</option>
                    </select>
                    <div class="ml-auto">
                        <button onclick="exportData('traslados')" class="flex items-center gap-2 px-3 py-1.5 text-sm bg-green-50 text-green-700 border border-green-200 rounded-lg hover:bg-green-100">
                            <i data-lucide="download" class="w-3.5 h-3.5"></i>Exportar CSV
                        </button>
                    </div>
                </div>
                <div id="traslados-content" class="space-y-2"></div>
            </div>

            <!-- ===== COMPRAS ===== -->
            <div id="page-compras" class="page">
                <div class="flex flex-wrap items-center gap-3 mb-4">
                    <select id="filtro-compra-prioridad" onchange="loadCompras()" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5">
                        <option value="">Todas las prioridades</option>
                        <option value="URGENTE">Urgente</option>
                        <option value="ALTA">Alta</option>
                        <option value="MEDIA">Media</option>
                        <option value="BAJA">Baja</option>
                    </select>
                    <select id="filtro-compra-marca" onchange="loadCompras()" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5">
                        <option value="">Todas las marcas</option>
                    </select>
                    <select id="filtro-compra-orden" onchange="sortAndRenderCompras()" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5 bg-blue-50 text-blue-700">
                        <option value="prioridad">Por prioridad</option>
                        <option value="stock_desc">Mayor stock</option>
                        <option value="stock_asc">Menor stock</option>
                        <option value="valor_desc">Mayor valor compra</option>
                        <option value="valor_asc">Menor valor compra</option>
                        <option value="cant_desc">Mayor cant. sugerida</option>
                    </select>
                    <div class="ml-auto">
                        <button onclick="exportData('compras')" class="flex items-center gap-2 px-3 py-1.5 text-sm bg-green-50 text-green-700 border border-green-200 rounded-lg hover:bg-green-100">
                            <i data-lucide="download" class="w-3.5 h-3.5"></i>Exportar CSV
                        </button>
                    </div>
                </div>
                <div id="compras-kpis" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4"></div>
                <div id="compras-content"></div>
            </div>

            <!-- ===== ALMACENES ===== -->
            <div id="page-almacenes" class="page">
                <div class="flex flex-wrap items-center gap-3 mb-4">
                    <div class="flex bg-gray-100 rounded-lg p-0.5">
                        <button onclick="switchAlmacenesView('cards')" id="btn-alm-cards" class="px-3 py-1.5 text-xs font-medium rounded-md bg-white shadow-sm text-gray-800">Tarjetas</button>
                        <button onclick="switchAlmacenesView('table')" id="btn-alm-table" class="px-3 py-1.5 text-xs font-medium rounded-md text-gray-500">Tabla</button>
                    </div>
                    <select id="filtro-almacen-tipo" onchange="loadAlmacenes()" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5">
                        <option value="Venta">Venta</option>
                        <option value="Reserva">Reserva</option>
                        <option value="Laboratorio">Laboratorio</option>
                        <option value="Show Room">Show Room</option>
                        <option value="">Todos los tipos</option>
                    </select>
                    <div class="ml-auto">
                        <button onclick="exportData('almacenes')" class="flex items-center gap-2 px-3 py-1.5 text-sm bg-green-50 text-green-700 border border-green-200 rounded-lg hover:bg-green-100">
                            <i data-lucide="download" class="w-3.5 h-3.5"></i>Exportar CSV
                        </button>
                    </div>
                </div>
                <div id="almacenes-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                <div id="almacenes-content" class="hidden"></div>
            </div>

            <!-- ===== ANÁLISIS ===== -->
            <div id="page-analisis" class="page">
                <div class="flex flex-wrap items-center gap-3 mb-4">
                    <select id="filtro-analisis-tipo" onchange="loadAnalisis()" class="text-sm border border-gray-200 rounded-lg px-3 py-1.5">
                        <option value="Venta">Almacenes Venta</option>
                        <option value="Reserva">Reserva</option>
                        <option value="">Todos los tipos</option>
                    </select>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500">Ventas desde</span>
                        <input type="date" id="filtro-analisis-desde" onchange="loadAnalisis()" class="text-sm border border-gray-200 rounded-lg px-2 py-1.5 text-gray-600 focus:outline-none focus:border-blue-400">
                        <span class="text-xs text-gray-500">hasta</span>
                        <input type="date" id="filtro-analisis-hasta" onchange="loadAnalisis()" class="text-sm border border-gray-200 rounded-lg px-2 py-1.5 text-gray-600 focus:outline-none focus:border-blue-400">
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="setAnalisisRango(7)" class="px-2 py-1 text-[10px] border border-gray-200 rounded text-gray-500 hover:bg-blue-50 hover:text-blue-600">7d</button>
                        <button onclick="setAnalisisRango(15)" class="px-2 py-1 text-[10px] border border-gray-200 rounded text-gray-500 hover:bg-blue-50 hover:text-blue-600">15d</button>
                        <button onclick="setAnalisisRango(30)" class="px-2 py-1 text-[10px] border border-gray-200 rounded bg-blue-50 text-blue-600 font-medium">30d</button>
                        <button onclick="setAnalisisRango(60)" class="px-2 py-1 text-[10px] border border-gray-200 rounded text-gray-500 hover:bg-blue-50 hover:text-blue-600">60d</button>
                        <button onclick="setAnalisisRango(90)" class="px-2 py-1 text-[10px] border border-gray-200 rounded text-gray-500 hover:bg-blue-50 hover:text-blue-600">90d</button>
                    </div>
                    <div class="ml-auto flex items-center gap-3">
                        <button onclick="exportData('almacenes')" class="flex items-center gap-2 px-3 py-1.5 text-sm bg-green-50 text-green-700 border border-green-200 rounded-lg hover:bg-green-100">
                            <i data-lucide="download" class="w-3.5 h-3.5"></i>Exportar CSV
                        </button>
                    </div>
                </div>
                <div id="analisis-resumen" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 mb-6">
                    <h3 class="text-sm font-semibold text-gray-700 mb-4">Distribución de Inventario por Marca</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div style="height:300px;position:relative"><canvas id="chart-marcas-pie"></canvas></div>
                        <div style="height:300px;position:relative"><canvas id="chart-marcas-bar"></canvas></div>
                    </div>
                </div>
                <div id="analisis-tabla"></div>
            </div>

            <!-- ===== PRODUCTOS ===== -->
            <div id="page-productos" class="page">
                <div class="mb-4">
                    <div class="relative max-w-lg">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                        <input id="producto-search" type="text" placeholder="Buscar por nombre, referencia o código..."
                            class="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-400"
                            oninput="debounceSearch()">
                    </div>
                </div>
                <div id="productos-results"></div>
                <div id="producto-detalle" class="hidden mt-6"></div>
            </div>

            <!-- ===== REGIONALES ===== -->
            <div id="page-regionales" class="page">
                <div id="regionales-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- ===== USUARIOS (ADMIN) ===== -->
            <div id="page-usuarios" class="page">
                <div class="flex items-center justify-between mb-6">
                    <p class="text-sm text-gray-500">Gestión de usuarios y permisos de acceso</p>
                    <button onclick="openUserModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors">
                        <i data-lucide="user-plus" class="w-4 h-4"></i>Nuevo Usuario
                    </button>
                </div>
                <div id="usuarios-table-wrap" class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-500 text-xs uppercase">
                            <tr>
                                <th class="px-4 py-3 text-left">Usuario</th>
                                <th class="px-4 py-3 text-left">Nombre</th>
                                <th class="px-4 py-3 text-left">Rol</th>
                                <th class="px-4 py-3 text-left">Módulos</th>
                                <th class="px-4 py-3 text-center">Estado</th>
                                <th class="px-4 py-3 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="usuarios-tbody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ============ MODAL PRODUCTO ============ -->
<div id="modal-producto" class="hidden fixed inset-0 z-40 modal-overlay flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[85vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-100 px-6 py-4 flex items-center justify-between rounded-t-2xl">
            <h3 id="modal-title" class="font-semibold text-gray-800">Detalle de Producto</h3>
            <button onclick="closeModal()" class="p-1 hover:bg-gray-100 rounded-lg"><i data-lucide="x" class="w-5 h-5 text-gray-400"></i></button>
        </div>
        <div id="modal-body" class="p-6"></div>
    </div>
</div>

<!-- ============ MODAL USUARIO ============ -->
<div id="modal-usuario" class="hidden fixed inset-0 z-50 modal-overlay flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-100 px-6 py-4 flex items-center justify-between rounded-t-2xl">
            <h3 id="modal-user-title" class="font-semibold text-gray-800">Nuevo Usuario</h3>
            <button onclick="closeUserModal()" class="p-1 hover:bg-gray-100 rounded-lg"><i data-lucide="x" class="w-5 h-5 text-gray-400"></i></button>
        </div>
        <div class="p-6 space-y-4">
            <input type="hidden" id="edit-user-id" value="">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Username</label>
                    <input id="inp-username" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="usuario">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Contraseña <span id="pwd-hint" class="text-gray-400 font-normal">(requerida)</span></label>
                    <input id="inp-password" type="password" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••">
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Nombre completo</label>
                    <input id="inp-nombre" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nombre">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Email</label>
                    <input id="inp-email" type="email" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="correo@empresa.com">
                </div>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Rol</label>
                <select id="inp-rol" onchange="onRolChange()" class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="viewer">Viewer - Solo lectura</option>
                    <option value="manager">Manager - Gestión</option>
                    <option value="admin">Admin - Acceso total</option>
                </select>
            </div>
            <div id="modulos-section">
                <label class="block text-xs font-medium text-gray-600 mb-2">Módulos permitidos</label>
                <div class="grid grid-cols-2 gap-2" id="modulos-checkboxes">
                    <label class="flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors">
                        <input type="checkbox" value="dashboard" class="mod-check rounded text-blue-600 w-4 h-4" checked>
                        <i data-lucide="layout-dashboard" class="w-3.5 h-3.5 text-gray-400"></i>
                        <span class="text-xs text-gray-700">Dashboard</span>
                    </label>
                    <label class="flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors">
                        <input type="checkbox" value="alertas" class="mod-check rounded text-blue-600 w-4 h-4">
                        <i data-lucide="alert-triangle" class="w-3.5 h-3.5 text-gray-400"></i>
                        <span class="text-xs text-gray-700">Alertas</span>
                    </label>
                    <label class="flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors">
                        <input type="checkbox" value="traslados" class="mod-check rounded text-blue-600 w-4 h-4">
                        <i data-lucide="truck" class="w-3.5 h-3.5 text-gray-400"></i>
                        <span class="text-xs text-gray-700">Traslados</span>
                    </label>
                    <label class="flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors">
                        <input type="checkbox" value="compras" class="mod-check rounded text-blue-600 w-4 h-4">
                        <i data-lucide="shopping-cart" class="w-3.5 h-3.5 text-gray-400"></i>
                        <span class="text-xs text-gray-700">Compras</span>
                    </label>
                    <label class="flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors">
                        <input type="checkbox" value="almacenes" class="mod-check rounded text-blue-600 w-4 h-4">
                        <i data-lucide="warehouse" class="w-3.5 h-3.5 text-gray-400"></i>
                        <span class="text-xs text-gray-700">Almacenes</span>
                    </label>
                    <label class="flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors">
                        <input type="checkbox" value="analisis" class="mod-check rounded text-blue-600 w-4 h-4">
                        <i data-lucide="pie-chart" class="w-3.5 h-3.5 text-gray-400"></i>
                        <span class="text-xs text-gray-700">Análisis</span>
                    </label>
                    <label class="flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors">
                        <input type="checkbox" value="productos" class="mod-check rounded text-blue-600 w-4 h-4">
                        <i data-lucide="search" class="w-3.5 h-3.5 text-gray-400"></i>
                        <span class="text-xs text-gray-700">Productos</span>
                    </label>
                    <label class="flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg cursor-pointer hover:bg-blue-50 transition-colors">
                        <input type="checkbox" value="regionales" class="mod-check rounded text-blue-600 w-4 h-4">
                        <i data-lucide="map-pin" class="w-3.5 h-3.5 text-gray-400"></i>
                        <span class="text-xs text-gray-700">Regionales</span>
                    </label>
                </div>
            </div>
            <div id="user-modal-error" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-xs"></div>
            <div class="flex justify-end gap-3 pt-2">
                <button onclick="closeUserModal()" class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">Cancelar</button>
                <button onclick="saveUser()" id="btn-save-user" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors">Crear Usuario</button>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================
// CONFIG & STATE
// ============================================
const API_URL = 'https://tls8rexfqb.execute-api.us-east-1.amazonaws.com/prod/api';
let token = localStorage.getItem('stockiq_token');
let currentUser = null;
let currentPage = 'dashboard';
let filtros = {};
let salesChart = null;
let searchTimer = null;
let cachedAlertas = [];
let cachedTraslados = [];
let cachedCompras = [];

// ============================================
// API HELPERS
// ============================================
async function api(path, opts = {}) {
    const headers = { 'Content-Type': 'application/json', ...(opts.headers || {}) };
    if (token) headers['Authorization'] = `Bearer ${token}`;
    const res = await fetch(API_URL + path, { ...opts, headers });
    if (res.status === 401) { doLogout(); throw new Error('Sesión expirada'); }
    const data = await res.json();
    if (res.status >= 400) throw new Error(data.error || 'Error en la API');
    return data;
}

function formatCurrency(v) {
    return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(v);
}
function formatNumber(v) { return new Intl.NumberFormat('es-CO').format(Math.round(v)); }
function diasMeses(d) {
    if (d >= 9999) return '∞';
    const dias = Math.round(d);
    const meses = (d / 30).toFixed(1);
    return `${formatNumber(dias)}d <span class="text-gray-400">(${meses}m)</span>`;
}
function diasMesesPlain(d) {
    if (d >= 9999) return '∞';
    return `${Math.round(d)}d (${(d / 30).toFixed(1)}m)`;
}
function badge(text, type) {
    const cls = type ? `badge-${type.toLowerCase()}` : 'bg-gray-100 text-gray-600';
    return `<span class="px-2 py-0.5 rounded text-xs font-medium ${cls}">${text}</span>`;
}
function truncate(s, n = 55) { return s && s.length > n ? s.substring(0, n) + '...' : (s || ''); }
function fmtMensaje(msg) {
    return msg.replace(/\$(\d+)/g, (_, n) => '$' + formatNumber(Number(n)));
}

// ============================================
// AUTH
// ============================================
async function doLogin() {
    const u = document.getElementById('login-user').value;
    const p = document.getElementById('login-pass').value;
    const errEl = document.getElementById('login-error');
    errEl.classList.add('hidden');
    try {
        const data = await fetch(API_URL + '/auth/login', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: u, password: p })
        }).then(r => r.json());
        if (data.error) { errEl.textContent = data.error; errEl.classList.remove('hidden'); return; }
        token = data.token;
        currentUser = data.user;
        localStorage.setItem('stockiq_token', token);
        showApp();
    } catch (e) { errEl.textContent = 'Error de conexión'; errEl.classList.remove('hidden'); }
}

function doLogout() {
    if (token) api('/auth/logout', { method: 'POST' }).catch(() => {});
    token = null; currentUser = null;
    localStorage.removeItem('stockiq_token');
    document.getElementById('app').classList.add('hidden');
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('login-user').value = '';
    document.getElementById('login-pass').value = '';
}

async function checkAuth() {
    if (!token) return false;
    try {
        currentUser = await api('/auth/me');
        return true;
    } catch { token = null; localStorage.removeItem('stockiq_token'); return false; }
}

function showApp() {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    if (currentUser) {
        document.getElementById('user-name').textContent = currentUser.nombre || currentUser.username;
        document.getElementById('user-role').textContent = currentUser.rol;
        document.getElementById('user-avatar').textContent = (currentUser.nombre || currentUser.username)[0].toUpperCase();
    }
    applyModuleAccess();
    initApp();
}

function applyModuleAccess() {
    if (!currentUser) return;
    const isAdmin = currentUser.rol === 'admin';
    const mods = currentUser.modulos || [];

    document.getElementById('nav-admin-section').classList.toggle('hidden', !isAdmin);

    const allPages = ['dashboard','alertas','traslados','compras','almacenes','analisis','productos','regionales'];
    allPages.forEach(p => {
        const navEl = document.querySelector(`.sidebar-item[data-page="${p}"]`);
        if (navEl) {
            const allowed = isAdmin || mods.includes(p);
            navEl.classList.toggle('hidden', !allowed);
        }
    });
}

// ============================================
// NAVIGATION
// ============================================
function showPage(page) {
    currentPage = page;
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + page).classList.add('active');
    document.querySelectorAll('.sidebar-item').forEach(s => s.classList.remove('active'));
    document.querySelector(`.sidebar-item[data-page="${page}"]`).classList.add('active');
    const titles = { dashboard: 'Dashboard', alertas: 'Alertas', traslados: 'Traslados', compras: 'Compras Sugeridas', almacenes: 'Almacenes', analisis: 'Análisis de Inventario', productos: 'Búsqueda de Productos', regionales: 'Regionales', usuarios: 'Gestión de Usuarios' };
    document.getElementById('page-title').textContent = titles[page] || page;
    refreshCurrentPage();
    lucide.createIcons();
}

function refreshCurrentPage() {
    const loaders = {
        dashboard: loadDashboard, alertas: loadAlertas, traslados: loadTraslados,
        compras: loadCompras, almacenes: loadAlmacenes, productos: () => {},
        analisis: loadAnalisis, regionales: loadRegionales, usuarios: loadUsuarios
    };
    if (loaders[currentPage]) loaders[currentPage]();
    document.getElementById('last-update').textContent = 'Actualizado: ' + new Date().toLocaleTimeString('es-CO');
}

// ============================================
// MULTI-SELECT FILTERS
// ============================================
const multiState = {
    regional: { selected: new Set(), items: [], allLabel: 'Todas las regionales' },
    almacen:  { selected: new Set(), items: [], allLabel: 'Todos los almacenes' },
    marca:    { selected: new Set(), items: [], allLabel: 'Todas las marcas' },
    tiporef:  { selected: new Set(), items: [], allLabel: 'Tipo Referencia' }
};

function getRegional() { return [...multiState.regional.selected].join(','); }
function getAlmacen()  { return [...multiState.almacen.selected].join(','); }
function getMarca()    { return [...multiState.marca.selected].join(','); }
function getTipoRef()  { return [...multiState.tiporef.selected].join(','); }

function toggleMultiDrop(key) {
    const dd = document.getElementById(key + '-dropdown');
    const isOpen = !dd.classList.contains('hidden');
    closeAllMultiDrops();
    if (!isOpen) {
        dd.classList.remove('hidden');
        renderMultiList(key);
        document.getElementById(key + '-search').focus();
    }
}

function closeAllMultiDrops() {
    ['regional','almacen','marca','tiporef'].forEach(k =>
        document.getElementById(k + '-dropdown').classList.add('hidden'));
}

document.addEventListener('click', e => {
    ['regional','almacen','marca','tiporef'].forEach(k => {
        if (!document.getElementById(k + '-search-wrap').contains(e.target))
            document.getElementById(k + '-dropdown').classList.add('hidden');
    });
});

function filterMultiDrop(key) {
    renderMultiList(key);
}

function renderMultiList(key) {
    const st = multiState[key];
    const q = document.getElementById(key + '-search').value.toLowerCase();
    let items = st.items;
    if (q) items = items.filter(it => it.label.toLowerCase().includes(q) || it.code.toLowerCase().includes(q));
    const container = document.getElementById(key + '-list');
    container.innerHTML = items.map(it => {
        const checked = st.selected.has(it.code) ? 'checked' : '';
        return `<label class="flex items-center gap-2 px-3 py-1.5 text-xs text-gray-700 hover:bg-blue-50 cursor-pointer">
            <input type="checkbox" ${checked} onchange="toggleMultiItem('${key}','${it.code}')" class="rounded text-blue-600 w-3.5 h-3.5">
            <span class="truncate">${it.label}</span>
            ${it.extra ? `<span class="text-gray-400 ml-auto text-[10px]">${it.extra}</span>` : ''}
        </label>`;
    }).join('');
}

function toggleMultiItem(key, code) {
    const st = multiState[key];
    if (st.selected.has(code)) st.selected.delete(code);
    else st.selected.add(code);
    updateMultiLabel(key);
    if (key === 'regional') updateAlmacenItems();
    refreshCurrentPage();
}

function multiSelectAll(key) {
    const st = multiState[key];
    const q = document.getElementById(key + '-search').value.toLowerCase();
    let items = st.items;
    if (q) items = items.filter(it => it.label.toLowerCase().includes(q) || it.code.toLowerCase().includes(q));
    items.forEach(it => st.selected.add(it.code));
    updateMultiLabel(key);
    renderMultiList(key);
    if (key === 'regional') updateAlmacenItems();
    refreshCurrentPage();
}

function multiClearAll(key) {
    multiState[key].selected.clear();
    updateMultiLabel(key);
    renderMultiList(key);
    if (key === 'regional') updateAlmacenItems();
    refreshCurrentPage();
}

function updateMultiLabel(key) {
    const st = multiState[key];
    const label = document.getElementById(key + '-label');
    const n = st.selected.size;
    if (n === 0) label.textContent = st.allLabel;
    else if (n === 1) {
        const it = st.items.find(i => i.code === [...st.selected][0]);
        label.textContent = it ? it.label : [...st.selected][0];
    } else {
        label.textContent = `${n} seleccionados`;
    }
    label.classList.toggle('text-blue-600', n > 0);
    label.classList.toggle('font-medium', n > 0);
}

function updateAlmacenItems() {
    const regSel = multiState.regional.selected;
    multiState.almacen.items = regSel.size > 0
        ? filtros.almacenes.filter(a => regSel.has(a.regional)).map(a => ({ code: a.codigo, label: a.nombre, extra: a.regional }))
        : filtros.almacenes.map(a => ({ code: a.codigo, label: a.nombre, extra: a.regional }));
    const validCodes = new Set(multiState.almacen.items.map(i => i.code));
    multiState.almacen.selected = new Set([...multiState.almacen.selected].filter(c => validCodes.has(c)));
    updateMultiLabel('almacen');
}

function onFilterChange() { refreshCurrentPage(); }

function buildGlobalQS() {
    const r = getRegional(), a = getAlmacen(), m = getMarca(), t = getTipoRef();
    let qs = '';
    if (r) qs += `regional=${encodeURIComponent(r)}&`;
    if (a) qs += `almacen=${encodeURIComponent(a)}&`;
    if (m) qs += `marca=${encodeURIComponent(m)}&`;
    if (t) qs += `tipo_ref=${encodeURIComponent(t)}&`;
    return qs;
}

// ============================================
// DASHBOARD
// ============================================
async function loadDashboard() {
    try {
        const g = buildGlobalQS();
        let qs = '?' + g;
        const [kpis, eficiencia, top, analisis, regionales, almResumen] = await Promise.all([
            api('/kpis' + qs), api('/ventas/eficiencia' + qs), api('/ventas/top-productos' + qs + 'limit=10'),
            api('/analisis/inventario?tipo=Venta&' + g),
            api('/regionales?' + g),
            api('/almacenes/resumen?tipo=Venta&' + g)
        ]);
        renderKPIs(kpis);
        renderSaludCards(kpis.salud_inventario);
        renderEficienciaChart(eficiencia);
        renderTopProductos(top);
        renderDashPieMarca(analisis);
        renderDashPieRegional(regionales);
        renderDashPieEstado(kpis.salud_inventario);
        renderDashTablaAlmacenes(almResumen);
        document.getElementById('nav-count-alertas').textContent = kpis.alertas.total || '';
        document.getElementById('nav-count-traslados').textContent = kpis.traslados_pendientes || '';
    } catch (e) { console.error('Error dashboard:', e); }
}

function renderKPIs(k) {
    document.getElementById('kpi-cards').innerHTML = `
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl shadow-sm p-5 text-white">
            <div class="flex items-center justify-between">
                <div><p class="text-xs font-medium text-slate-300">Valor Inventario</p>
                    <p class="text-xl font-bold mt-1">${formatCurrency(k.inventario.valor_inventario)}</p>
                    <p class="text-[11px] text-slate-400 mt-0.5">${formatNumber(k.inventario.total_productos)} SKUs · ${k.inventario.total_almacenes} almacenes</p></div>
                <div class="p-2.5 rounded-lg bg-white/10"><i data-lucide="dollar-sign" class="w-5 h-5 text-white"></i></div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
            <div class="flex items-center justify-between">
                <div><p class="text-xs text-gray-500 font-medium">Ventas (30 días)</p>
                    <p class="text-xl font-bold mt-1 text-blue-600">${formatCurrency(k.ventas_30d.valor)}</p>
                    <p class="text-[11px] text-gray-400 mt-0.5">${formatNumber(k.ventas_30d.transacciones)} transacciones</p></div>
                <div class="p-2.5 rounded-lg bg-blue-50"><i data-lucide="trending-up" class="w-5 h-5 text-blue-600"></i></div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
            <div class="flex items-center justify-between">
                <div><p class="text-xs text-gray-500 font-medium">Alertas Activas</p>
                    <p class="text-xl font-bold mt-1 ${k.alertas.criticas > 0 ? 'text-red-600' : 'text-yellow-600'}">${k.alertas.total}</p>
                    <p class="text-[11px] text-gray-400 mt-0.5">${k.alertas.criticas} críticas · ${k.alertas.agotado || 0} agotado · ${k.alertas.sin_rotacion || 0} sin rotación</p></div>
                <div class="p-2.5 rounded-lg ${k.alertas.criticas > 0 ? 'bg-red-50' : 'bg-yellow-50'}"><i data-lucide="alert-triangle" class="w-5 h-5 ${k.alertas.criticas > 0 ? 'text-red-600' : 'text-yellow-600'}"></i></div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
            <div class="flex items-center justify-between">
                <div><p class="text-xs text-gray-500 font-medium">Traslados Pendientes</p>
                    <p class="text-xl font-bold mt-1 text-purple-600">${k.traslados_pendientes}</p>
                    <p class="text-[11px] text-gray-400 mt-0.5">Por ejecutar</p></div>
                <div class="p-2.5 rounded-lg bg-purple-50"><i data-lucide="truck" class="w-5 h-5 text-purple-600"></i></div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
            <div class="flex items-center justify-between">
                <div><p class="text-xs text-gray-500 font-medium">Compras Sugeridas</p>
                    <p class="text-xl font-bold mt-1 text-orange-600">${k.compras.total}</p>
                    <p class="text-[11px] text-gray-400 mt-0.5">${formatCurrency(k.compras.valor_estimado)}</p></div>
                <div class="p-2.5 rounded-lg bg-orange-50"><i data-lucide="shopping-cart" class="w-5 h-5 text-orange-600"></i></div>
            </div>
        </div>
        ${k.venta_perdida ? `
        <div class="bg-gradient-to-br from-rose-500 to-red-600 rounded-xl shadow-sm p-5 text-white">
            <div class="flex items-center justify-between">
                <div><p class="text-xs font-medium text-rose-100">Venta Perdida</p>
                    <p class="text-xl font-bold mt-1">${formatCurrency(k.venta_perdida.valor)}</p>
                    <p class="text-[11px] text-rose-200 mt-0.5">${formatNumber(k.venta_perdida.items)} SKUs · ${formatNumber(k.venta_perdida.unidades)} uds sin stock</p></div>
                <div class="p-2.5 rounded-lg bg-white/20"><i data-lucide="ban" class="w-5 h-5 text-white"></i></div>
            </div>
        </div>` : ''}
        ${k.proyectos ? `
        <div class="bg-gradient-to-br from-indigo-500 to-violet-600 rounded-xl shadow-sm p-5 text-white">
            <div class="flex items-center justify-between">
                <div><p class="text-xs font-medium text-indigo-100">Proyectos</p>
                    <p class="text-xl font-bold mt-1">${formatNumber(k.proyectos.items)} <span class="text-xs font-normal text-indigo-200">SKUs</span></p>
                    <p class="text-[11px] text-indigo-200 mt-0.5">${formatNumber(k.proyectos.unidades)} uds · ${formatCurrency(k.proyectos.valor)}</p></div>
                <div class="p-2.5 rounded-lg bg-white/20"><i data-lucide="briefcase" class="w-5 h-5 text-white"></i></div>
            </div>
        </div>` : ''}`;
    lucide.createIcons();
}

function renderSaludCards(s) {
    if (!s) { document.getElementById('salud-cards').innerHTML = ''; return; }
    const cats = [
        { key: 'sano', label: 'Stock Sano', desc: 'Ventas activas', icon: 'check-circle', color: 'emerald', bg: 'emerald' },
        { key: 'agotado', label: 'Agotado', desc: 'Demanda sin stock', icon: 'x-circle', color: 'rose', bg: 'rose' },
        { key: 'critico', label: 'Crítico', desc: 'Riesgo agotarse', icon: 'alert-octagon', color: 'red', bg: 'red' },
        { key: 'bajo', label: 'Stock Bajo', desc: 'Bajo mínimo', icon: 'alert-triangle', color: 'yellow', bg: 'yellow' },
        { key: 'sobreinventario', label: 'Sobreinventario', desc: 'Exceso de stock', icon: 'archive', color: 'orange', bg: 'orange' },
        { key: 'baja_rotacion', label: 'Baja Rotación', desc: 'Poca venta 90d', icon: 'activity', color: 'amber', bg: 'amber' },
        { key: 'sin_rotacion', label: 'Sin Rotación', desc: 'Sin ventas 30d', icon: 'pause-circle', color: 'violet', bg: 'violet' }
    ];

    const catCards = cats.map(c => {
        const d = s[c.key] || { skus: 0, valor: 0, pct: 0 };
        return `
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-3">
            <div class="flex items-center gap-2 mb-2">
                <div class="p-1.5 rounded-lg bg-${c.bg}-50"><i data-lucide="${c.icon}" class="w-3.5 h-3.5 text-${c.color}-600"></i></div>
                <div class="min-w-0">
                    <p class="text-[11px] font-semibold text-gray-700 truncate">${c.label}</p>
                    <p class="text-[9px] text-gray-400 truncate">${c.desc}</p>
                </div>
            </div>
            <div class="flex items-end justify-between">
                <div>
                    <p class="text-base font-bold text-${c.color}-600">${formatNumber(d.skus)}</p>
                    <p class="text-[9px] text-gray-400">SKUs · ${formatCurrency(d.valor)}</p>
                </div>
                <p class="text-sm font-bold text-${c.color}-600">${d.pct}%</p>
            </div>
            <div class="mt-1.5 w-full h-1 bg-gray-100 rounded-full overflow-hidden">
                <div class="h-full bg-${c.color}-500 rounded-full transition-all" style="width:${Math.min(d.pct, 100)}%"></div>
            </div>
        </div>`;
    }).join('');

    document.getElementById('salud-cards').innerHTML = catCards;
    lucide.createIcons();
}

function renderEficienciaChart(resp) {
    const data = resp.datos || [];
    const ventaTotal = data.reduce((s, d) => s + d.venta, 0);
    const invPromedio = data.length > 0 ? data.reduce((s, d) => s + d.inventario, 0) / data.length : 0;
    const pctTotal = invPromedio > 0 ? (ventaTotal / invPromedio * 100).toFixed(2) : '0.00';
    document.getElementById('eficiencia-total').textContent = `${pctTotal}% eficiencia 30d · Venta ${formatCurrency(ventaTotal)} · Inv. prom. ${formatCurrency(invPromedio)}`;

    const ctx = document.getElementById('chart-ventas');
    if (salesChart) salesChart.destroy();
    salesChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => { const dt = new Date(d.fecha + 'T12:00:00'); return dt.toLocaleDateString('es-CO', { day: '2-digit', month: 'short' }); }),
            datasets: [
                {
                    label: 'Inventario disponible',
                    data: data.map(d => d.inventario),
                    backgroundColor: 'rgba(16,185,129,.18)',
                    borderColor: '#10b981', borderWidth: 1, borderRadius: 3,
                    yAxisID: 'y', order: 3
                },
                {
                    label: 'Venta diaria',
                    data: data.map(d => d.venta),
                    backgroundColor: 'rgba(59,130,246,.55)',
                    borderColor: '#3b82f6', borderWidth: 1, borderRadius: 3,
                    yAxisID: 'y', order: 2
                },
                {
                    label: '% Venta/Inventario',
                    data: data.map(d => d.eficiencia),
                    borderColor: '#f59e0b', backgroundColor: 'transparent',
                    type: 'line', tension: 0.3, pointRadius: 2, borderWidth: 2,
                    yAxisID: 'y1', order: 1
                }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: {
                legend: { display: true, position: 'top', labels: { boxWidth: 12, font: { size: 11 } } },
                tooltip: { callbacks: { label: ctx => ctx.dataset.yAxisID === 'y1'
                    ? `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%`
                    : `${ctx.dataset.label}: ${formatCurrency(ctx.parsed.y)}` } }
            },
            scales: {
                y: {
                    position: 'left', ticks: { callback: v => formatCurrency(v), font: { size: 10 } },
                    grid: { color: '#f3f4f6' }, title: { display: false }
                },
                y1: {
                    position: 'right', min: 0,
                    ticks: { callback: v => v.toFixed(2) + '%', font: { size: 10 } },
                    grid: { display: false }, title: { display: false }
                },
                x: { grid: { display: false }, ticks: { maxTicksLimit: 10, font: { size: 10 } } }
            }
        }
    });
}

function renderTopProductos(data) {
    if (!data.length) { document.getElementById('top-productos-list').innerHTML = '<p class="text-gray-400 text-sm text-center py-8">Sin datos</p>'; return; }
    document.getElementById('top-productos-list').innerHTML = data.map((p, i) => `
        <div class="flex items-center gap-3 py-2 ${i > 0 ? 'border-t border-gray-50' : ''}">
            <span class="w-6 h-6 rounded-full ${i < 3 ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-500'} flex items-center justify-center text-xs font-bold">${i+1}</span>
            <div class="flex-1 min-w-0">
                <p class="text-sm text-gray-800 truncate">${truncate(p.producto_nombre || p.referencia, 40)}</p>
                <p class="text-[11px] text-gray-400">${p.almacenes_venta} almacenes</p>
            </div>
            <div class="text-right">
                <p class="text-sm font-semibold text-gray-800">${formatNumber(p.unidades_vendidas)} uds</p>
                <p class="text-[11px] text-gray-400">${formatCurrency(p.valor_vendido)}</p>
            </div>
        </div>
    `).join('');
}

// ============================================
// DASHBOARD CHARTS (tortas + tabla almacenes)
// ============================================
let dashPieMarca = null, dashPieRegional = null, dashPieEstado = null;
const PIE_COLORS = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#f97316','#84cc16','#6366f1','#94a3b8'];

function renderDashPieMarca(data) {
    const m = (data.marcas || []).slice(0, 8);
    const others = (data.marcas || []).slice(8);
    const labels = m.map(x => x.nombre);
    const values = m.map(x => x.valor);
    if (others.length) { labels.push('Otras (' + others.length + ')'); values.push(others.reduce((s,x) => s + x.valor, 0)); }
    if (dashPieMarca) dashPieMarca.destroy();
    dashPieMarca = new Chart(document.getElementById('dash-pie-marca'), {
        type: 'doughnut',
        data: { labels, datasets: [{ data: values, backgroundColor: PIE_COLORS }] },
        options: { responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'right', labels: { font: { size: 9 }, boxWidth: 10, padding: 6 } },
                tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.raw)} (${(ctx.raw/data.total_valor*100).toFixed(1)}%)` } } } }
    });
}

function renderDashPieRegional(resp) {
    const data = resp.regionales || [];
    const total = resp.inventario_total || 1;
    const labels = data.map(r => r.nombre);
    const values = data.map(r => r.valor_inventario);
    if (dashPieRegional) dashPieRegional.destroy();
    dashPieRegional = new Chart(document.getElementById('dash-pie-regional'), {
        type: 'doughnut',
        data: { labels, datasets: [{ data: values, backgroundColor: PIE_COLORS }] },
        options: { responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'right', labels: { font: { size: 9 }, boxWidth: 10, padding: 6 } },
                tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.raw)} (${(ctx.raw/total*100).toFixed(1)}%)` } } } }
    });
}

function renderDashPieEstado(s) {
    if (!s) return;
    const sr = s.sin_rotacion || { valor: 0 };
    const ag = s.agotado || { valor: 0 };
    const br = s.baja_rotacion || { valor: 0 };
    const labels = ['Sano', 'Agotado', 'Crítico', 'Bajo', 'Sobreinventario', 'Baja Rotación', 'Sin Rotación'];
    const values = [s.sano.valor, ag.valor, s.critico.valor, s.bajo.valor, s.sobreinventario.valor, br.valor, sr.valor];
    const colors = ['#10b981', '#e11d48', '#ef4444', '#f59e0b', '#f97316', '#d97706', '#8b5cf6'];
    const totalVal = values.reduce((a, b) => a + b, 0) || 1;
    if (dashPieEstado) dashPieEstado.destroy();
    dashPieEstado = new Chart(document.getElementById('dash-pie-estado'), {
        type: 'doughnut',
        data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
        options: { responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'right', labels: { font: { size: 9 }, boxWidth: 10, padding: 6 } },
                tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.raw)} (${(ctx.raw/totalVal*100).toFixed(1)}%)` } } } }
    });
}

function renderDashTablaAlmacenes(resp) {
    const data = resp.almacenes || [];
    const total = resp.inventario_total || 1;
    document.getElementById('dash-tabla-almacenes').innerHTML = !data.length
        ? '<p class="text-gray-400 text-center py-6">Sin datos</p>'
        : `<div class="overflow-x-auto"><table class="w-full text-xs">
            <thead><tr class="border-b border-gray-200 bg-gray-50">
                <th class="text-left py-2.5 px-3 font-medium text-gray-600">Almacén</th>
                <th class="text-left py-2.5 px-3 font-medium text-gray-600">Regional</th>
                <th class="text-right py-2.5 px-3 font-medium text-gray-600">Valor Inventario</th>
                <th class="text-right py-2.5 px-3 font-medium text-gray-600">% Total</th>
                <th class="text-right py-2.5 px-3 font-medium text-gray-600">Ventas 30d</th>
                <th class="text-right py-2.5 px-3 font-medium text-gray-600">Rotación</th>
                <th class="text-right py-2.5 px-3 font-medium text-gray-600">Alertas</th>
            </tr></thead>
            <tbody>${data.map(a => `
                <tr class="border-b border-gray-50 hover:bg-gray-50">
                    <td class="py-2 px-3"><span class="font-medium text-gray-900">${a.nombre}</span>${a.es_cedi ? ' <span class="text-[9px] bg-blue-100 text-blue-700 px-1 rounded">CEDI</span>' : ''}</td>
                    <td class="py-2 px-3 text-gray-500">${a.regional || '-'}</td>
                    <td class="py-2 px-3 text-right font-medium">${formatCurrency(a.valor_inventario)}</td>
                    <td class="py-2 px-3 text-right">
                        <div class="flex items-center justify-end gap-1">
                            <div class="w-14 h-1.5 bg-gray-100 rounded-full overflow-hidden"><div class="h-full bg-blue-500 rounded-full" style="width:${Math.min(a.pct_inventario,100)}%"></div></div>
                            <span class="font-semibold w-10 text-right">${a.pct_inventario}%</span>
                        </div>
                    </td>
                    <td class="py-2 px-3 text-right">${formatCurrency(a.ventas_30d_valor)}</td>
                    <td class="py-2 px-3 text-right"><span class="font-semibold ${a.rotacion_pct > 30 ? 'text-green-600' : a.rotacion_pct > 15 ? 'text-yellow-600' : 'text-red-600'}">${a.rotacion_pct}%</span></td>
                    <td class="py-2 px-3 text-right">${formatNumber(a.alertas_total)} <span class="text-gray-400">(${formatNumber(a.stock_critico)}c)</span></td>
                </tr>
            `).join('')}</tbody>
        </table></div>`;
}

// ============================================
// ALERTAS
// ============================================
async function loadAlertas() {
    const tipo = document.getElementById('filtro-alerta-tipo').value;
    const estado = document.getElementById('filtro-alerta-estado').value;
    let qs = `?limit=100&${buildGlobalQS()}`;
    if (tipo) qs += `&tipo=${tipo}`;
    if (estado) qs += `&estado=${estado}`;

    try {
        cachedAlertas = await api('/alertas' + qs);
        sortAndRenderAlertas();
    } catch (e) { console.error(e); }
}

function sortAndRenderAlertas() {
    const orden = document.getElementById('filtro-alerta-orden').value;
    const sorted = [...cachedAlertas];
    if (orden === 'stock_desc') sorted.sort((a, b) => b.stock_actual - a.stock_actual);
    else if (orden === 'stock_asc') sorted.sort((a, b) => a.stock_actual - b.stock_actual);
    else if (orden === 'valor_desc') sorted.sort((a, b) => (b.valor_stock || 0) - (a.valor_stock || 0));
    else if (orden === 'valor_asc') sorted.sort((a, b) => (a.valor_stock || 0) - (b.valor_stock || 0));
    renderAlertas(sorted);
}

function renderAlertas(data) {
    const el = document.getElementById('alertas-content');
    if (!data.length) { el.innerHTML = '<p class="text-center text-gray-400 py-12">No hay alertas con estos filtros</p>'; return; }
    const borderColors = { CRITICO: 'border-red-500', ALTO: 'border-orange-500', MEDIO: 'border-yellow-500', BAJO: 'border-blue-500' };
    const bgColors = { CRITICO: 'bg-red-50', ALTO: 'bg-orange-50', MEDIO: 'bg-yellow-50', BAJO: 'bg-blue-50' };
    const tipoLabels = {
        'STOCK_CRITICO': 'Stock Crítico', 'STOCK_BAJO': 'Stock Bajo',
        'SOBREINVENTARIO': 'Sobreinventario', 'BAJA_ROTACION': 'Baja Rotación',
        'SIN_ROTACION': 'Sin Rotación'
    };
    const accionSugerida = {
        'STOCK_CRITICO': '🔴 Reabastecer urgente',
        'STOCK_BAJO': '🟡 Programar reabastecimiento',
        'SOBREINVENTARIO': '📦 Redistribuir / Trasladar',
        'BAJA_ROTACION': '🔄 Evaluar descontinuar',
        'SIN_ROTACION': '🏷️ Promoción / Oferta / Redistribución'
    };
    el.innerHTML = data.map(a => {
        const isSinRot = a.tipo_alerta === 'SIN_ROTACION';
        const bColor = isSinRot ? 'border-slate-500' : (borderColors[a.nivel] || 'border-gray-300');
        const bgColor = isSinRot ? 'bg-slate-50' : (bgColors[a.nivel] || 'bg-gray-50');
        const diasInvTxt = a.dias_inventario < 9999 ? diasMesesPlain(a.dias_inventario) : 'Sin venta';
        return `
        <div class="p-4 rounded-lg border-l-4 ${bColor} ${bgColor} flex items-start justify-between gap-4">
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 flex-wrap">
                    ${badge(a.nivel, a.nivel)}
                    <span class="text-xs font-medium ${isSinRot ? 'text-slate-700 bg-slate-200 px-1.5 py-0.5 rounded' : 'text-gray-500'}">${tipoLabels[a.tipo_alerta] || a.tipo_alerta.replace(/_/g, ' ')}</span>
                    <span class="text-[10px] font-mono bg-gray-200 text-gray-600 px-1.5 py-0.5 rounded">${a.referencia}</span>
                    ${a.marca_codigo ? `<span class="text-[10px] text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded font-medium">${a.marca_codigo}</span>` : ''}
                    ${a.estado !== 'PENDIENTE' ? `<span class="text-xs px-2 py-0.5 rounded bg-gray-200 text-gray-600">${a.estado}</span>` : ''}
                </div>
                <p class="font-medium text-gray-900 mt-1 text-sm">${truncate(a.producto_nombre || a.referencia, 70)}</p>
                <p class="text-xs text-gray-600 mt-1">
                    <span class="inline-flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3"></i>${a.almacen_nombre || a.bodega_codigo}</span>
                    ${a.regional ? ` · ${a.regional}` : ''} · Stock: <strong>${formatNumber(a.stock_actual)}</strong>
                    · ${diasInvTxt}${a.valor_stock ? ` · Valor: <strong>${formatCurrency(a.valor_stock)}</strong>` : ''}
                    · Nac: <strong>${formatNumber(a.stock_nacional)}</strong>
                </p>
                <p class="text-[11px] mt-1 ${isSinRot ? 'text-slate-600 font-medium' : 'text-gray-400'}">
                    ${accionSugerida[a.tipo_alerta] || ''}${a.mensaje ? ' — ' + fmtMensaje(a.mensaje) : ''}
                </p>
                ${a.atendida_por ? `<p class="text-[11px] text-gray-400 mt-1">Atendida por ${a.atendida_por}</p>` : ''}
            </div>
            ${a.estado === 'PENDIENTE' ? `
            <div class="flex gap-1 flex-shrink-0">
                <button onclick="updateAlerta(${a.id}, 'ATENDIDA')" class="px-2 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200" title="Marcar como atendida">Atender</button>
                <button onclick="updateAlerta(${a.id}, 'IGNORADA')" class="px-2 py-1 text-xs bg-gray-100 text-gray-600 rounded hover:bg-gray-200" title="Ignorar">Ignorar</button>
            </div>` : ''}
        </div>`;
    }).join('');
    lucide.createIcons();
}

async function updateAlerta(id, estado) {
    try { await api(`/alertas/${id}/estado`, { method: 'PATCH', body: JSON.stringify({ estado }) }); loadAlertas(); }
    catch (e) { alert('Error: ' + e.message); }
}

// ============================================
// TRASLADOS
// ============================================
async function loadTraslados() {
    const prioridad = document.getElementById('filtro-traslado-prioridad').value;
    const estado = document.getElementById('filtro-traslado-estado').value;
    let qs = `?limit=100&${buildGlobalQS()}`;
    if (prioridad) qs += `&prioridad=${prioridad}`;
    if (estado) qs += `&estado=${estado}`;
    try {
        cachedTraslados = await api('/traslados' + qs);
        populateTrasladoAlmacenFilters();
        sortAndRenderTraslados();
    } catch (e) { console.error(e); }
}

function populateTrasladoAlmacenFilters() {
    const origenes = [...new Set(cachedTraslados.map(t => t.origen_nombre || t.bodega_origen))].sort();
    const destinos = [...new Set(cachedTraslados.map(t => t.destino_nombre || t.bodega_destino))].sort();
    const selOrig = document.getElementById('filtro-traslado-origen');
    const selDest = document.getElementById('filtro-traslado-destino');
    const prevOrig = selOrig.value, prevDest = selDest.value;
    selOrig.innerHTML = '<option value="">Almacén Origen</option>' + origenes.map(o => `<option value="${o}">${o}</option>`).join('');
    selDest.innerHTML = '<option value="">Almacén Destino</option>' + destinos.map(d => `<option value="${d}">${d}</option>`).join('');
    if (origenes.includes(prevOrig)) selOrig.value = prevOrig;
    if (destinos.includes(prevDest)) selDest.value = prevDest;
}

function sortAndRenderTraslados() {
    const orden = document.getElementById('filtro-traslado-orden').value;
    const filtroOrigen = document.getElementById('filtro-traslado-origen').value;
    const filtroDestino = document.getElementById('filtro-traslado-destino').value;
    let filtered = [...cachedTraslados];
    if (filtroOrigen) filtered = filtered.filter(t => (t.origen_nombre || t.bodega_origen) === filtroOrigen);
    if (filtroDestino) filtered = filtered.filter(t => (t.destino_nombre || t.bodega_destino) === filtroDestino);
    if (orden === 'stock_desc') filtered.sort((a, b) => b.cantidad_sugerida - a.cantidad_sugerida);
    else if (orden === 'stock_asc') filtered.sort((a, b) => a.cantidad_sugerida - b.cantidad_sugerida);
    renderTraslados(filtered);
}

function renderTraslados(data) {
    const el = document.getElementById('traslados-content');
    if (!data.length) { el.innerHTML = '<p class="text-center text-gray-400 py-12">No hay traslados con estos filtros</p>'; return; }
    el.innerHTML = data.map(t => `
        <div class="p-4 bg-white rounded-lg border border-gray-200 hover:shadow-md transition-shadow flex items-center gap-4">
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 flex-wrap">
                    ${badge(t.prioridad, t.prioridad)}
                    <span class="text-[10px] font-mono bg-gray-200 text-gray-600 px-1.5 py-0.5 rounded">${t.referencia}</span>
                    ${t.estado !== 'PENDIENTE' ? `<span class="text-xs px-2 py-0.5 rounded bg-gray-200 text-gray-600">${t.estado}</span>` : ''}
                </div>
                <p class="font-medium text-gray-900 text-sm mt-1">${truncate(t.producto_nombre || t.referencia, 55)}</p>
                <div class="flex items-center gap-2 mt-1.5 text-sm">
                    <span class="text-gray-500">${t.origen_nombre || t.bodega_origen}</span>
                    <i data-lucide="arrow-right" class="w-3.5 h-3.5 text-blue-500"></i>
                    <span class="font-medium text-blue-600">${t.destino_nombre || t.bodega_destino}</span>
                </div>
                <div class="flex items-center gap-4 mt-1 text-xs text-gray-500">
                    <span>Cantidad: <strong>${formatNumber(t.cantidad_sugerida)}</strong></span>
                    <span>Origen: ${diasMesesPlain(t.dias_inv_origen)}</span>
                    <span>Destino: ${diasMesesPlain(t.dias_inv_destino)}</span>
                    ${t.regional ? `<span>· ${t.regional}</span>` : ''}
                </div>
            </div>
            ${t.estado === 'PENDIENTE' ? `
            <div class="flex flex-col gap-1 flex-shrink-0">
                <button onclick="updateTraslado(${t.id}, 'APROBADO')" class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200">Aprobar</button>
                <button onclick="updateTraslado(${t.id}, 'EJECUTADO')" class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200">Ejecutar</button>
                <button onclick="updateTraslado(${t.id}, 'RECHAZADO')" class="px-3 py-1 text-xs bg-red-100 text-red-600 rounded hover:bg-red-200">Rechazar</button>
            </div>` : ''}
        </div>
    `).join('');
    lucide.createIcons();
}

async function updateTraslado(id, estado) {
    try { await api(`/traslados/${id}/estado`, { method: 'PATCH', body: JSON.stringify({ estado }) }); loadTraslados(); }
    catch (e) { alert('Error: ' + e.message); }
}

// ============================================
// COMPRAS
// ============================================
async function loadCompras() {
    const prioridad = document.getElementById('filtro-compra-prioridad').value;
    const marca = document.getElementById('filtro-compra-marca').value;
    let qs = `?limit=100&${buildGlobalQS()}`;
    if (prioridad) qs += `&prioridad=${prioridad}`;
    if (marca) qs += `&marca=${marca}`;
    try {
        cachedCompras = await api('/compras' + qs);
        sortAndRenderCompras();
    } catch (e) { console.error(e); }
}

function sortAndRenderCompras() {
    const orden = document.getElementById('filtro-compra-orden').value;
    const sorted = [...cachedCompras];
    if (orden === 'stock_desc') sorted.sort((a, b) => b.stock_red - a.stock_red);
    else if (orden === 'stock_asc') sorted.sort((a, b) => a.stock_red - b.stock_red);
    else if (orden === 'valor_desc') sorted.sort((a, b) => b.valor_compra_estimado - a.valor_compra_estimado);
    else if (orden === 'valor_asc') sorted.sort((a, b) => a.valor_compra_estimado - b.valor_compra_estimado);
    else if (orden === 'cant_desc') sorted.sort((a, b) => b.cantidad_sugerida - a.cantidad_sugerida);
    renderCompras(sorted);
}

function renderCompras(data) {
    const el = document.getElementById('compras-content');
    const kpiEl = document.getElementById('compras-kpis');

    // KPIs resumen
    const totalValor = data.reduce((s, c) => s + c.valor_compra_estimado, 0);
    const totalUnidades = data.reduce((s, c) => s + c.cantidad_sugerida, 0);
    const marcasSet = new Set(data.map(c => c.marca_nombre).filter(Boolean));
    // Venta perdida: para items con cobertura < lead time (15d default), estimamos
    // la venta diaria que se pierde por no tener stock suficiente
    const ventaPerdida = data.reduce((s, c) => {
        if (c.dias_cobertura_actual <= 0 && c.costo_unitario_estimado > 0) {
            const ventaDiaria = c.venta_proyectada / 30;
            return s + (ventaDiaria * c.costo_unitario_estimado * 30);
        }
        if (c.dias_cobertura_actual < 15 && c.costo_unitario_estimado > 0) {
            const ventaDiaria = c.venta_proyectada / 30;
            const diasSinStock = 15 - c.dias_cobertura_actual;
            return s + (ventaDiaria * diasSinStock * c.costo_unitario_estimado);
        }
        return s;
    }, 0);

    kpiEl.innerHTML = `
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-blue-50"><i data-lucide="shopping-cart" class="w-4 h-4 text-blue-600"></i></div>
                <div>
                    <p class="text-[10px] text-gray-500 font-medium">Valor Total Compra</p>
                    <p class="text-lg font-bold text-blue-600">${formatCurrency(totalValor)}</p>
                    <p class="text-[10px] text-gray-400">${data.length} productos</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-red-50"><i data-lucide="trending-down" class="w-4 h-4 text-red-600"></i></div>
                <div>
                    <p class="text-[10px] text-gray-500 font-medium">Venta Perdida Estimada</p>
                    <p class="text-lg font-bold text-red-600">${formatCurrency(ventaPerdida)}</p>
                    <p class="text-[10px] text-gray-400">si no reabastecemos a tiempo</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-emerald-50"><i data-lucide="package" class="w-4 h-4 text-emerald-600"></i></div>
                <div>
                    <p class="text-[10px] text-gray-500 font-medium">Unidades a Comprar</p>
                    <p class="text-lg font-bold text-emerald-600">${formatNumber(totalUnidades)}</p>
                    <p class="text-[10px] text-gray-400">${data.length} referencias</p>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-lg bg-purple-50"><i data-lucide="building-2" class="w-4 h-4 text-purple-600"></i></div>
                <div>
                    <p class="text-[10px] text-gray-500 font-medium">Proveedores / Marcas</p>
                    <p class="text-lg font-bold text-purple-600">${marcasSet.size}</p>
                    <p class="text-[10px] text-gray-400">${[...marcasSet].slice(0, 3).join(', ')}${marcasSet.size > 3 ? '...' : ''}</p>
                </div>
            </div>
        </div>`;
    lucide.createIcons();

    if (!data.length) { el.innerHTML = '<p class="text-center text-gray-400 py-12">No hay recomendaciones de compra</p>'; return; }
    el.innerHTML = `
        <div class="bg-white rounded-xl border border-gray-100 overflow-x-auto">
            <table class="w-full text-sm">
                <thead><tr class="border-b border-gray-200 bg-gray-50">
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Producto</th>
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Marca</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-600">Stock Red</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-600">Cant. Sugerida</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-600">Cob. Actual (d/m)</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-600">Cob. Obj. (d/m)</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-600">Valor Est.</th>
                    <th class="text-center py-3 px-4 font-medium text-gray-600">Prioridad</th>
                </tr></thead>
                <tbody>${data.map(c => `
                    <tr class="border-b border-gray-50 hover:bg-gray-50">
                        <td class="py-2.5 px-4">
                            <p class="font-medium text-gray-900 text-xs">${truncate(c.producto_nombre || c.referencia, 40)}</p>
                            <p class="text-[11px] text-gray-400">${c.referencia}</p>
                        </td>
                        <td class="py-2.5 px-4 text-xs text-gray-600">${c.marca_nombre || '-'} <span class="text-gray-400">${c.marca_clasificacion || ''}</span></td>
                        <td class="py-2.5 px-4 text-right text-xs">${formatNumber(c.stock_actual_red)}</td>
                        <td class="py-2.5 px-4 text-right text-xs font-semibold text-blue-600">${formatNumber(c.cantidad_sugerida)}</td>
                        <td class="py-2.5 px-4 text-right text-xs ${c.dias_cobertura_actual < 7 ? 'text-red-600 font-semibold' : ''}">${diasMesesPlain(c.dias_cobertura_actual)}</td>
                        <td class="py-2.5 px-4 text-right text-xs text-gray-500">${diasMesesPlain(c.dias_cobertura_objetivo)}</td>
                        <td class="py-2.5 px-4 text-right text-xs">${formatCurrency(c.valor_compra_estimado)}</td>
                        <td class="py-2.5 px-4 text-center">${badge(c.prioridad, c.prioridad)}</td>
                    </tr>
                `).join('')}</tbody>
            </table>
        </div>`;
}

// ============================================
// ALMACENES
// ============================================
let almacenesView = 'cards';

function switchAlmacenesView(view) {
    almacenesView = view;
    document.getElementById('btn-alm-cards').className = `px-3 py-1.5 text-xs font-medium rounded-md ${view === 'cards' ? 'bg-white shadow-sm text-gray-800' : 'text-gray-500'}`;
    document.getElementById('btn-alm-table').className = `px-3 py-1.5 text-xs font-medium rounded-md ${view === 'table' ? 'bg-white shadow-sm text-gray-800' : 'text-gray-500'}`;
    document.getElementById('almacenes-cards').className = view === 'cards' ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4' : 'hidden';
    document.getElementById('almacenes-content').className = view === 'table' ? '' : 'hidden';
    loadAlmacenes();
}

async function loadAlmacenes() {
    const tipo = document.getElementById('filtro-almacen-tipo').value;
    let qs = `?${buildGlobalQS()}`;
    if (tipo) qs += `tipo=${tipo}&`;
    try {
        if (almacenesView === 'cards') {
            const resp = await api('/almacenes/resumen' + qs);
            renderAlmacenesCards(resp.almacenes, resp.inventario_total);
        } else {
            renderAlmacenes(await api('/almacenes' + qs));
        }
    } catch (e) { console.error(e); }
}

function renderAlmacenesCards(data, invTotal) {
    const el = document.getElementById('almacenes-cards');
    if (!data.length) { el.innerHTML = '<p class="text-gray-400 text-center py-12 col-span-3">Sin almacenes con estos filtros</p>'; return; }
    const colors = ['from-blue-500 to-blue-700','from-emerald-500 to-emerald-700','from-purple-500 to-purple-700','from-orange-500 to-orange-700','from-pink-500 to-pink-700','from-cyan-500 to-cyan-700','from-indigo-500 to-indigo-700','from-teal-500 to-teal-700'];
    el.innerHTML = data.map((a, i) => `
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r ${colors[i % colors.length]} px-5 py-3">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-white font-bold text-sm">${a.nombre}</h3>
                        <p class="text-white/70 text-[10px]">${a.regional || '-'} · ${a.tipo}${a.es_cedi ? ' · CEDI' : ''}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-white font-bold text-lg">${a.pct_inventario}%</p>
                        <p class="text-white/60 text-[9px]">del inventario total</p>
                    </div>
                </div>
            </div>
            <div class="p-4 space-y-2.5">
                <div class="flex justify-between"><span class="text-xs text-gray-500">Valor Inventario</span><span class="text-sm font-semibold">${formatCurrency(a.valor_inventario)}</span></div>
                <div class="flex justify-between"><span class="text-xs text-gray-500">Productos / Unidades</span><span class="text-sm font-semibold">${formatNumber(a.productos)} / ${formatNumber(a.unidades)}</span></div>
                <div class="flex justify-between"><span class="text-xs text-gray-500">Ventas 30 días</span><span class="text-sm font-semibold text-blue-600">${formatCurrency(a.ventas_30d_valor)}</span></div>
                <div class="flex justify-between"><span class="text-xs text-gray-500">Alertas</span>
                    <span class="text-sm font-semibold ${a.alertas_criticas > 0 ? 'text-red-600' : ''}">${a.alertas_total}
                        <span class="text-[10px] font-normal text-gray-400">(${a.stock_critico} crít · ${a.stock_bajo} bajo · ${a.sobreinventario} sobre · ${a.sin_rotacion || 0} s/rot)</span>
                    </span>
                </div>
                ${a.valor_inventario > 0 ? `
                <div class="pt-2 border-t border-gray-100">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">Rotación 30d</span>
                        <span class="text-sm font-bold ${a.rotacion_pct > 30 ? 'text-green-600' : a.rotacion_pct > 15 ? 'text-yellow-600' : 'text-red-600'}">${a.rotacion_pct}%</span>
                    </div>
                    <div class="mt-1 w-full h-1.5 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full rounded-full ${a.rotacion_pct > 30 ? 'bg-green-500' : a.rotacion_pct > 15 ? 'bg-yellow-500' : 'bg-red-500'}" style="width:${Math.min(a.rotacion_pct, 100)}%"></div>
                    </div>
                </div>` : ''}
            </div>
        </div>
    `).join('');
}

function renderAlmacenes(data) {
    const el = document.getElementById('almacenes-content');
    if (!data.length) { el.innerHTML = '<p class="text-center text-gray-400 py-12">No hay almacenes con estos filtros</p>'; return; }
    el.innerHTML = `
        <div class="bg-white rounded-xl border border-gray-100 overflow-x-auto">
            <table class="w-full text-sm">
                <thead><tr class="border-b border-gray-200 bg-gray-50">
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Almacén</th>
                    <th class="text-left py-3 px-4 font-medium text-gray-600">Regional</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-600">Productos</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-600">Unidades</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-600">Valor</th>
                    <th class="text-right py-3 px-4 font-medium text-gray-600">Días / Meses Inv.</th>
                </tr></thead>
                <tbody>${data.map(a => `
                    <tr class="border-b border-gray-50 hover:bg-gray-50">
                        <td class="py-2.5 px-4"><p class="font-medium text-gray-900 text-xs">${a.nombre}</p><p class="text-[11px] text-gray-400">${a.codigo}${a.es_cedi ? ' · CEDI' : ''}</p></td>
                        <td class="py-2.5 px-4 text-xs text-gray-600">${a.regional || '-'}</td>
                        <td class="py-2.5 px-4 text-right text-xs">${formatNumber(a.productos)}</td>
                        <td class="py-2.5 px-4 text-right text-xs">${formatNumber(a.unidades)}</td>
                        <td class="py-2.5 px-4 text-right text-xs">${formatCurrency(a.valor_inventario)}</td>
                        <td class="py-2.5 px-4 text-right"><span class="px-2 py-0.5 rounded text-xs font-medium ${
                            a.dias_inv_promedio < 15 ? 'bg-red-100 text-red-700' : a.dias_inv_promedio < 30 ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'
                        }">${a.dias_inv_promedio ? diasMesesPlain(a.dias_inv_promedio) : '-'}</span></td>
                    </tr>
                `).join('')}</tbody>
            </table>
        </div>`;
}

// ============================================
// PRODUCTOS
// ============================================
function debounceSearch() {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(searchProductos, 400);
}

async function searchProductos() {
    const q = document.getElementById('producto-search').value.trim();
    const el = document.getElementById('productos-results');
    document.getElementById('producto-detalle').classList.add('hidden');
    if (q.length < 2) { el.innerHTML = '<p class="text-gray-400 text-sm text-center py-8">Escribe al menos 2 caracteres para buscar</p>'; return; }
    try {
        const data = await api(`/productos/buscar?q=${encodeURIComponent(q)}&limit=30`);
        if (!data.length) { el.innerHTML = '<p class="text-gray-400 text-sm text-center py-8">Sin resultados</p>'; return; }
        el.innerHTML = `<div class="bg-white rounded-xl border border-gray-100 overflow-x-auto">
            <table class="w-full text-sm"><thead><tr class="border-b border-gray-200 bg-gray-50">
                <th class="text-left py-3 px-4 font-medium text-gray-600">Producto</th>
                <th class="text-left py-3 px-4 font-medium text-gray-600">Marca</th>
                <th class="text-right py-3 px-4 font-medium text-gray-600">Stock Total</th>
                <th class="text-right py-3 px-4 font-medium text-gray-600">Almacenes</th>
                <th class="text-center py-3 px-4 font-medium text-gray-600">Acción</th>
            </tr></thead><tbody>${data.map(p => `
                <tr class="border-b border-gray-50 hover:bg-gray-50 cursor-pointer" onclick="openProductoDetalle('${encodeURIComponent(p.referencia)}')">
                    <td class="py-2.5 px-4"><p class="font-medium text-gray-900 text-xs">${truncate(p.nombre || p.referencia, 45)}</p><p class="text-[11px] text-gray-400">${p.referencia}</p></td>
                    <td class="py-2.5 px-4 text-xs text-gray-600">${p.marca || '-'}</td>
                    <td class="py-2.5 px-4 text-right text-xs font-semibold">${formatNumber(p.stock_total)}</td>
                    <td class="py-2.5 px-4 text-right text-xs">${p.almacenes_con_stock}</td>
                    <td class="py-2.5 px-4 text-center"><button class="text-blue-600 hover:text-blue-800 text-xs font-medium">Ver detalle</button></td>
                </tr>
            `).join('')}</tbody></table></div>`;
    } catch (e) { el.innerHTML = `<p class="text-red-500 text-sm text-center py-4">${e.message}</p>`; }
}

async function openProductoDetalle(refEncoded) {
    try {
        const data = await api(`/productos/detalle?ref=${refEncoded}`);
        if (!data) return;
        const p = data.producto;
        const estadoColors = { CRITICO: 'text-red-600', BAJO: 'text-orange-600', NORMAL: 'text-green-600', SOBRE: 'text-yellow-600', EXCESO: 'text-red-600' };
        document.getElementById('modal-title').textContent = truncate(p.nombre || p.referencia, 60);
        document.getElementById('modal-body').innerHTML = `
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div><p class="text-xs text-gray-500">Referencia</p><p class="text-sm font-medium">${p.referencia}</p></div>
                <div><p class="text-xs text-gray-500">Marca</p><p class="text-sm font-medium">${p.marca || '-'} <span class="text-gray-400">${p.categoria || ''} ${p.clasificacion || ''}</span></p></div>
                <div><p class="text-xs text-gray-500">Stock Total</p><p class="text-sm font-bold text-blue-600">${formatNumber(data.almacenes.reduce((s,a) => s + a.stock, 0))}</p></div>
                <div><p class="text-xs text-gray-500">Cobertura Obj.</p><p class="text-sm font-medium">${p.dias_cobertura ? diasMesesPlain(p.dias_cobertura) : '-'}</p></div>
            </div>
            <h4 class="font-semibold text-sm text-gray-700 mb-3">Stock por Almacén (${data.almacenes.length})</h4>
            <div class="bg-gray-50 rounded-lg overflow-x-auto mb-6">
                <table class="w-full text-xs">
                    <thead><tr class="border-b border-gray-200">
                        <th class="text-left py-2 px-3 font-medium text-gray-600">Almacén</th>
                        <th class="text-left py-2 px-3 font-medium text-gray-600">Regional</th>
                        <th class="text-right py-2 px-3 font-medium text-gray-600">Stock</th>
                        <th class="text-right py-2 px-3 font-medium text-gray-600">Vta. Diaria</th>
                        <th class="text-right py-2 px-3 font-medium text-gray-600">Días / Meses Inv.</th>
                        <th class="text-center py-2 px-3 font-medium text-gray-600">Estado</th>
                    </tr></thead>
                    <tbody>${data.almacenes.map(a => `
                        <tr class="border-b border-gray-100">
                            <td class="py-2 px-3 font-medium">${a.nombre} <span class="text-gray-400">(${a.tipo})</span></td>
                            <td class="py-2 px-3 text-gray-500">${a.regional || '-'}</td>
                            <td class="py-2 px-3 text-right font-semibold">${formatNumber(a.stock)}</td>
                            <td class="py-2 px-3 text-right">${a.venta_diaria.toFixed(2)}</td>
                            <td class="py-2 px-3 text-right">${diasMesesPlain(a.dias_inventario)}</td>
                            <td class="py-2 px-3 text-center"><span class="font-medium ${estadoColors[a.estado] || 'text-gray-500'}">${a.estado}</span></td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            </div>
            ${data.ventas_30d.length ? `
            <h4 class="font-semibold text-sm text-gray-700 mb-3">Ventas últimos 30 días</h4>
            <canvas id="chart-producto-ventas" height="150"></canvas>` : '<p class="text-gray-400 text-sm">Sin ventas en los últimos 30 días</p>'}`;

        document.getElementById('modal-producto').classList.remove('hidden');
        lucide.createIcons();

        if (data.ventas_30d.length) {
            new Chart(document.getElementById('chart-producto-ventas'), {
                type: 'bar',
                data: {
                    labels: data.ventas_30d.map(v => { const d = new Date(v.fecha + 'T12:00:00'); return d.toLocaleDateString('es-CO', { day: '2-digit', month: 'short' }); }),
                    datasets: [{ label: 'Unidades', data: data.ventas_30d.map(v => v.cantidad), backgroundColor: 'rgba(59,130,246,.6)', borderRadius: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#f3f4f6' } }, x: { grid: { display: false } } } }
            });
        }
    } catch (e) { console.error(e); }
}

function closeModal() { document.getElementById('modal-producto').classList.add('hidden'); }

// ============================================
// ANÁLISIS INVENTARIO
// ============================================
let pieChart = null, barChart = null;

function initAnalisisFechas() {
    const hoy = new Date().toISOString().slice(0, 10);
    const d30 = new Date(Date.now() - 30 * 86400000).toISOString().slice(0, 10);
    const desde = document.getElementById('filtro-analisis-desde');
    const hasta = document.getElementById('filtro-analisis-hasta');
    if (!desde.value) desde.value = d30;
    if (!hasta.value) hasta.value = hoy;
}

function setAnalisisRango(dias) {
    const hoy = new Date().toISOString().slice(0, 10);
    const desde = new Date(Date.now() - dias * 86400000).toISOString().slice(0, 10);
    document.getElementById('filtro-analisis-desde').value = desde;
    document.getElementById('filtro-analisis-hasta').value = hoy;
    document.querySelectorAll('#page-analisis .flex.items-center.gap-1 button').forEach(b => {
        b.className = b.textContent.trim() === dias + 'd'
            ? 'px-2 py-1 text-[10px] border border-gray-200 rounded bg-blue-50 text-blue-600 font-medium'
            : 'px-2 py-1 text-[10px] border border-gray-200 rounded text-gray-500 hover:bg-blue-50 hover:text-blue-600';
    });
    loadAnalisis();
}

async function loadAnalisis() {
    initAnalisisFechas();
    const tipo = document.getElementById('filtro-analisis-tipo').value;
    const desde = document.getElementById('filtro-analisis-desde').value;
    const hasta = document.getElementById('filtro-analisis-hasta').value;
    let qs = `?${buildGlobalQS()}`;
    if (tipo) qs += `tipo=${tipo}&`;
    if (desde) qs += `fecha_desde=${desde}&`;
    if (hasta) qs += `fecha_hasta=${hasta}&`;
    try {
        const data = await api('/analisis/inventario' + qs);
        renderAnalisis(data);
    } catch (e) { console.error(e); }
}

function renderAnalisis(data) {
    const m = data.marcas || [];
    const diasLabel = data.dias_rango ? `${data.dias_rango}d` : '30d';
    const totalVenta = m.reduce((s, x) => s + (x.venta_periodo_valor || 0), 0);
    // Resumen cards
    document.getElementById('analisis-resumen').innerHTML = `
        <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
            <p class="text-xs text-gray-500">Valor Total Inventario</p>
            <p class="text-2xl font-bold text-emerald-600 mt-1">${formatCurrency(data.total_valor)}</p>
            <p class="text-[11px] text-gray-400">${formatNumber(data.total_unidades)} unidades</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
            <p class="text-xs text-gray-500">Venta del Periodo (${diasLabel})</p>
            <p class="text-2xl font-bold text-blue-600 mt-1">${formatCurrency(totalVenta)}</p>
            <p class="text-[11px] text-gray-400">${data.fecha_desde || ''} a ${data.fecha_hasta || ''}</p>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-5 border border-gray-100">
            <p class="text-xs text-gray-500">Marcas con Stock</p>
            <p class="text-lg font-bold text-purple-600 mt-1">${data.total_marcas}</p>
            <p class="text-[11px] text-gray-400">Top 5: ${m.slice(0,5).reduce((s,x) => s + x.pct_valor, 0).toFixed(1)}% del inventario</p>
        </div>`;

    // Charts
    const top10 = m.slice(0, 10);
    const others = m.slice(10);
    const pieLabels = top10.map(x => x.nombre);
    const pieValues = top10.map(x => x.valor);
    if (others.length > 0) {
        pieLabels.push('Otras (' + others.length + ')');
        pieValues.push(others.reduce((s, x) => s + x.valor, 0));
    }
    const colors = ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#06b6d4','#f97316','#84cc16','#6366f1','#94a3b8'];

    if (pieChart) pieChart.destroy();
    pieChart = new Chart(document.getElementById('chart-marcas-pie'), {
        type: 'doughnut',
        data: { labels: pieLabels, datasets: [{ data: pieValues, backgroundColor: colors }] },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { position: 'right', labels: { font: { size: 10 }, boxWidth: 12, padding: 8 } },
                tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.raw)} (${(ctx.raw/data.total_valor*100).toFixed(1)}%)` } } }
        }
    });

    if (barChart) barChart.destroy();
    barChart = new Chart(document.getElementById('chart-marcas-bar'), {
        type: 'bar',
        data: {
            labels: top10.map(x => x.nombre),
            datasets: [
                { label: 'Inventario', data: top10.map(x => x.valor), backgroundColor: 'rgba(59,130,246,.6)', borderRadius: 4 },
                { label: `Venta ${diasLabel}`, data: top10.map(x => x.venta_periodo_valor), backgroundColor: 'rgba(16,185,129,.6)', borderRadius: 4 }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false, indexAxis: 'y',
            plugins: { legend: { position: 'top', labels: { font: { size: 10 }, boxWidth: 12 } } },
            scales: { x: { ticks: { callback: v => formatCurrency(v), font: { size: 9 } }, grid: { color: '#f3f4f6' } }, y: { ticks: { font: { size: 10 } } } }
        }
    });

    // Tabla detallada
    document.getElementById('analisis-tabla').innerHTML = `
        <div class="bg-white rounded-xl border border-gray-100 overflow-x-auto">
            <table class="w-full text-xs">
                <thead><tr class="border-b border-gray-200 bg-gray-50">
                    <th class="text-left py-2.5 px-3 font-medium text-gray-600">Marca</th>
                    <th class="text-center py-2.5 px-3 font-medium text-gray-600">Cat.</th>
                    <th class="text-center py-2.5 px-3 font-medium text-gray-600">Clas.</th>
                    <th class="text-right py-2.5 px-3 font-medium text-gray-600">Productos</th>
                    <th class="text-right py-2.5 px-3 font-medium text-gray-600">Unidades</th>
                    <th class="text-right py-2.5 px-3 font-medium text-gray-600">Valor Inv.</th>
                    <th class="text-right py-2.5 px-3 font-medium text-gray-600">% Inv.</th>
                    <th class="text-right py-2.5 px-3 font-medium text-gray-600">Venta Periodo</th>
                    <th class="text-right py-2.5 px-3 font-medium text-gray-600">Rotación</th>
                </tr></thead>
                <tbody>${m.map(x => `
                    <tr class="border-b border-gray-50 hover:bg-gray-50">
                        <td class="py-2 px-3 font-medium text-gray-900">${x.nombre || 'Sin marca'}</td>
                        <td class="py-2 px-3 text-center"><span class="px-1.5 py-0.5 rounded text-[10px] ${x.categoria === 'PRINCIPAL' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'}">${x.categoria || '-'}</span></td>
                        <td class="py-2 px-3 text-center font-bold ${x.clasificacion === 'A' ? 'text-green-600' : x.clasificacion === 'B' ? 'text-blue-600' : x.clasificacion === 'C' ? 'text-yellow-600' : 'text-gray-400'}">${x.clasificacion || '-'}</td>
                        <td class="py-2 px-3 text-right">${formatNumber(x.productos)}</td>
                        <td class="py-2 px-3 text-right">${formatNumber(x.unidades)}</td>
                        <td class="py-2 px-3 text-right font-medium">${formatCurrency(x.valor)}</td>
                        <td class="py-2 px-3 text-right">
                            <div class="flex items-center justify-end gap-1">
                                <div class="w-12 h-1.5 bg-gray-100 rounded-full overflow-hidden"><div class="h-full bg-blue-500 rounded-full" style="width:${Math.min(x.pct_valor, 100)}%"></div></div>
                                <span class="font-semibold w-10 text-right">${x.pct_valor.toFixed(1)}%</span>
                            </div>
                        </td>
                        <td class="py-2 px-3 text-right">${formatCurrency(x.venta_periodo_valor)}</td>
                        <td class="py-2 px-3 text-right"><span class="font-semibold ${x.rotacion_pct > 30 ? 'text-green-600' : x.rotacion_pct > 15 ? 'text-yellow-600' : 'text-red-600'}">${x.rotacion_pct.toFixed(1)}%</span></td>
                    </tr>
                `).join('')}</tbody>
            </table>
        </div>`;
    lucide.createIcons();
}

// ============================================
// REGIONALES
// ============================================
async function loadRegionales() {
    try {
        const resp = await api('/regionales?' + buildGlobalQS());
        renderRegionales(resp.regionales, resp.inventario_total);
    } catch (e) { console.error(e); }
}

function renderRegionales(data, invTotal) {
    const el = document.getElementById('regionales-content');
    if (!data.length) { el.innerHTML = '<p class="text-gray-400 text-center py-12">Sin datos de regionales</p>'; return; }
    const colors = ['from-blue-500 to-blue-700', 'from-emerald-500 to-emerald-700', 'from-purple-500 to-purple-700', 'from-orange-500 to-orange-700', 'from-pink-500 to-pink-700'];
    el.innerHTML = data.map((r, i) => `
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="bg-gradient-to-r ${colors[i % colors.length]} px-5 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-white font-bold text-lg">${r.nombre}</h3>
                        <p class="text-white/70 text-xs">${r.almacenes_venta} almacenes de venta</p>
                    </div>
                    <div class="text-right">
                        <p class="text-white font-bold text-2xl">${r.pct_inventario}%</p>
                        <p class="text-white/60 text-[10px]">del inventario total</p>
                    </div>
                </div>
            </div>
            <div class="p-5 space-y-3">
                <div class="flex justify-between"><span class="text-xs text-gray-500">Valor Inventario</span><span class="text-sm font-semibold">${formatCurrency(r.valor_inventario)}</span></div>
                <div class="flex justify-between"><span class="text-xs text-gray-500">Ventas 30 días</span><span class="text-sm font-semibold text-blue-600">${formatCurrency(r.ventas_30d)}</span></div>
                <div class="flex justify-between"><span class="text-xs text-gray-500">Alertas Pendientes</span><span class="text-sm font-semibold ${r.alertas_criticas > 0 ? 'text-red-600' : ''}">${formatNumber(r.alertas_pendientes)} <span class="text-xs font-normal text-gray-400">(${formatNumber(r.alertas_criticas)} críticas)</span></span></div>
                <div class="flex justify-between"><span class="text-xs text-gray-500">Traslados Pendientes</span><span class="text-sm font-semibold text-purple-600">${formatNumber(r.traslados_pendientes)}</span></div>
                ${r.ventas_30d && r.valor_inventario ? `
                <div class="pt-2 border-t border-gray-100">
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-gray-500">Rotación</span>
                        <span class="text-sm font-bold ${(r.ventas_30d / r.valor_inventario) > 0.3 ? 'text-green-600' : 'text-yellow-600'}">${((r.ventas_30d / r.valor_inventario) * 100).toFixed(1)}%</span>
                    </div>
                </div>` : ''}
            </div>
        </div>
    `).join('');
}

// ============================================
// EXPORT
// ============================================
async function exportData(tipo) {
    let qs = `?limit=1000&${buildGlobalQS()}`;
    if (tipo === 'alertas') {
        qs += `&estado=${document.getElementById('filtro-alerta-estado').value}`;
        const t = document.getElementById('filtro-alerta-tipo').value;
        if (t) qs += `&tipo=${t}`;
    }
    if (tipo === 'traslados') {
        qs += `&estado=${document.getElementById('filtro-traslado-estado').value}`;
        const p = document.getElementById('filtro-traslado-prioridad').value;
        if (p) qs += `&prioridad=${p}`;
    }
    try {
        const res = await fetch(API_URL + `/export/${tipo}${qs}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Error al exportar');
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `stockiq_${tipo}_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    } catch (e) { alert('Error exportando: ' + e.message); }
}

// ============================================
// GESTIÓN DE USUARIOS (ADMIN)
// ============================================
async function loadUsuarios() {
    if (!currentUser || currentUser.rol !== 'admin') return;
    try {
        const users = await api('/admin/usuarios');
        renderUsuariosTable(users);
    } catch (e) { console.error('Error cargando usuarios:', e); }
}

function renderUsuariosTable(users) {
    const rolColors = { admin: 'bg-purple-100 text-purple-700', manager: 'bg-blue-100 text-blue-700', viewer: 'bg-gray-100 text-gray-600' };
    const rolLabels = { admin: 'Admin', manager: 'Manager', viewer: 'Viewer' };
    const modIcons = {
        dashboard: 'layout-dashboard', alertas: 'alert-triangle', traslados: 'truck',
        compras: 'shopping-cart', almacenes: 'warehouse', analisis: 'pie-chart',
        productos: 'search', regionales: 'map-pin'
    };

    const tbody = document.getElementById('usuarios-tbody');
    tbody.innerHTML = users.map(u => {
        const isMe = u.id === currentUser.id;
        const modBadges = (u.modulos || []).map(m =>
            `<span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded bg-blue-50 text-blue-600 text-[10px]"><i data-lucide="${modIcons[m] || 'circle'}" class="w-2.5 h-2.5"></i>${m}</span>`
        ).join(' ');

        return `<tr class="hover:bg-gray-50 ${!u.activo ? 'opacity-50' : ''}">
            <td class="px-4 py-3">
                <div class="flex items-center gap-2">
                    <div class="w-7 h-7 rounded-full ${isMe ? 'bg-blue-600' : 'bg-gray-300'} flex items-center justify-center text-white text-xs font-bold">
                        ${(u.nombre || u.username)[0].toUpperCase()}
                    </div>
                    <span class="font-medium text-gray-800">${u.username}</span>
                    ${isMe ? '<span class="text-[9px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded-full font-medium">Tú</span>' : ''}
                </div>
            </td>
            <td class="px-4 py-3 text-gray-600">${u.nombre || '-'}</td>
            <td class="px-4 py-3"><span class="px-2 py-0.5 rounded text-xs font-medium ${rolColors[u.rol] || ''}">${rolLabels[u.rol] || u.rol}</span></td>
            <td class="px-4 py-3"><div class="flex flex-wrap gap-1 max-w-xs">${u.rol === 'admin' ? '<span class="text-[10px] text-purple-600 font-medium">Todos los módulos</span>' : modBadges || '<span class="text-[10px] text-gray-400">Sin módulos</span>'}</div></td>
            <td class="px-4 py-3 text-center">
                <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium ${u.activo ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">
                    <span class="w-1.5 h-1.5 rounded-full ${u.activo ? 'bg-emerald-500' : 'bg-red-500'}"></span>
                    ${u.activo ? 'Activo' : 'Inactivo'}
                </span>
            </td>
            <td class="px-4 py-3 text-center">
                <div class="flex items-center justify-center gap-1">
                    <button onclick="editUser(${u.id})" class="p-1.5 hover:bg-blue-50 rounded-lg text-gray-400 hover:text-blue-600 transition-colors" title="Editar">
                        <i data-lucide="pencil" class="w-3.5 h-3.5"></i>
                    </button>
                    <button onclick="toggleUserActive(${u.id}, ${u.activo})" class="p-1.5 hover:bg-yellow-50 rounded-lg text-gray-400 hover:text-yellow-600 transition-colors" title="${u.activo ? 'Desactivar' : 'Activar'}">
                        <i data-lucide="${u.activo ? 'user-x' : 'user-check'}" class="w-3.5 h-3.5"></i>
                    </button>
                    ${!isMe ? `<button onclick="deleteUser(${u.id}, '${u.username}')" class="p-1.5 hover:bg-red-50 rounded-lg text-gray-400 hover:text-red-600 transition-colors" title="Eliminar">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                    </button>` : ''}
                </div>
            </td>
        </tr>`;
    }).join('');
    lucide.createIcons();
}

let editingUserData = null;

function openUserModal(userData = null) {
    editingUserData = userData;
    const modal = document.getElementById('modal-usuario');
    const title = document.getElementById('modal-user-title');
    const btn = document.getElementById('btn-save-user');
    const errEl = document.getElementById('user-modal-error');
    errEl.classList.add('hidden');

    document.getElementById('edit-user-id').value = userData ? userData.id : '';
    document.getElementById('inp-username').value = userData ? userData.username : '';
    document.getElementById('inp-username').disabled = !!userData;
    document.getElementById('inp-password').value = '';
    document.getElementById('inp-nombre').value = userData ? (userData.nombre || '') : '';
    document.getElementById('inp-email').value = userData ? (userData.email || '') : '';
    document.getElementById('inp-rol').value = userData ? userData.rol : 'viewer';
    document.getElementById('pwd-hint').textContent = userData ? '(dejar vacío para no cambiar)' : '(requerida)';

    title.textContent = userData ? 'Editar Usuario' : 'Nuevo Usuario';
    btn.textContent = userData ? 'Guardar Cambios' : 'Crear Usuario';

    const mods = userData ? (userData.modulos || []) : ['dashboard'];
    document.querySelectorAll('.mod-check').forEach(cb => {
        cb.checked = mods.includes(cb.value);
    });

    onRolChange();
    modal.classList.remove('hidden');
    lucide.createIcons();
    if (!userData) document.getElementById('inp-username').focus();
}

function closeUserModal() {
    document.getElementById('modal-usuario').classList.add('hidden');
    editingUserData = null;
}

function onRolChange() {
    const rol = document.getElementById('inp-rol').value;
    const section = document.getElementById('modulos-section');
    if (rol === 'admin') {
        section.classList.add('opacity-50', 'pointer-events-none');
        document.querySelectorAll('.mod-check').forEach(cb => cb.checked = true);
    } else {
        section.classList.remove('opacity-50', 'pointer-events-none');
    }
}

async function saveUser() {
    const errEl = document.getElementById('user-modal-error');
    errEl.classList.add('hidden');
    const editId = document.getElementById('edit-user-id').value;
    const isEdit = !!editId;

    const username = document.getElementById('inp-username').value.trim();
    const password = document.getElementById('inp-password').value.trim();
    const nombre = document.getElementById('inp-nombre').value.trim();
    const email = document.getElementById('inp-email').value.trim();
    const rol = document.getElementById('inp-rol').value;
    const modulos = [...document.querySelectorAll('.mod-check:checked')].map(cb => cb.value);

    if (!isEdit && (!username || !password)) {
        errEl.textContent = 'Username y contraseña son requeridos';
        errEl.classList.remove('hidden');
        return;
    }

    const payload = { nombre, email, rol, modulos };
    if (!isEdit) { payload.username = username; payload.password = password; }
    else if (password) { payload.password = password; }

    try {
        const url = isEdit ? `/admin/usuarios/${editId}` : '/admin/usuarios';
        const method = isEdit ? 'PUT' : 'POST';
        await api(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        closeUserModal();
        loadUsuarios();
    } catch (e) {
        errEl.textContent = e.message || 'Error guardando usuario';
        errEl.classList.remove('hidden');
    }
}

async function editUser(id) {
    try {
        const users = await api('/admin/usuarios');
        const u = users.find(x => x.id === id);
        if (u) openUserModal(u);
    } catch (e) { alert('Error cargando usuario: ' + e.message); }
}

async function toggleUserActive(id, currentlyActive) {
    if (!confirm(`¿${currentlyActive ? 'Desactivar' : 'Activar'} este usuario?`)) return;
    try {
        await api(`/admin/usuarios/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ activo: !currentlyActive })
        });
        loadUsuarios();
    } catch (e) { alert('Error: ' + e.message); }
}

async function deleteUser(id, username) {
    if (!confirm(`¿Eliminar permanentemente al usuario "${username}"? Esta acción no se puede deshacer.`)) return;
    try {
        await api(`/admin/usuarios/${id}`, { method: 'DELETE' });
        loadUsuarios();
    } catch (e) { alert('Error: ' + e.message); }
}

// ============================================
// INIT
// ============================================
async function initApp() {
    try {
        filtros = await api('/filtros');
        multiState.regional.items = filtros.regionales.map(r => ({ code: r.codigo, label: r.nombre, extra: '' }));
        multiState.almacen.items = filtros.almacenes.map(a => ({ code: a.codigo, label: a.nombre, extra: a.regional }));
        multiState.marca.items = filtros.marcas.map(m => ({ code: m.codigo, label: m.nombre, extra: m.categoria }));
        multiState.tiporef.items = (filtros.tipos_referencia || []).map(t => ({ code: t.codigo, label: t.nombre, extra: `${t.cantidad} refs` }));
        const principalHtml = filtros.marcas.filter(m => m.categoria === 'PRINCIPAL').map(m => `<option value="${m.codigo}">${m.nombre} (${m.clasificacion})</option>`).join('');
        document.getElementById('filtro-compra-marca').innerHTML = '<option value="">Todas las marcas</option>' + principalHtml;
    } catch (e) { console.error('Error cargando filtros:', e); }
    loadDashboard();
    setInterval(() => { if (currentPage === 'dashboard') loadDashboard(); }, 120000);
}

document.addEventListener('DOMContentLoaded', async () => {
    lucide.createIcons();
    document.getElementById('login-pass').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
    document.getElementById('login-user').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('login-pass').focus(); });
    if (await checkAuth()) showApp();
});
</script>
</body>
</html>
